<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>笔记</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="笔记"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="笔记"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="笔记"><meta property="og:type" content="blog"><meta property="og:title" content="笔记"><meta property="og:url" content="https://www.chengyao.xyz/"><meta property="og:site_name" content="笔记"><meta property="og:description" content="笔记"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.chengyao.xyz/img/og_image.png"><meta property="article:author" content="CY"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://www.chengyao.xyz/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.chengyao.xyz"},"headline":"笔记","image":["https://www.chengyao.xyz/img/og_image.png"],"author":{"@type":"Person","name":"CY"},"publisher":{"@type":"Organization","name":"笔记","logo":{"@type":"ImageObject","url":"https://www.chengyao.xyz/images/avatar.jpg"}},"description":"笔记"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/images/avatar.jpg" alt="笔记" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/tab-engineer"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-10T04:48:31.000Z" title="2021/7/10 下午12:48:31">2021-07-10</time>发表</span><span class="level-item"><time dateTime="2022-08-28T02:23:10.673Z" title="2022/8/28 上午10:23:10">2022-08-28</time>更新</span><span class="level-item">9 分钟读完 (大约1370个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/10/%E4%BD%BF%E7%94%A8Postfix%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6/">使用Postfix发送邮件</a></h1><div class="content"><p>下面介绍在<code>Ubuntu</code>下使用<code>Postfix</code>发送邮件的方法</p>
<h1 id="安装Postfix"><a href="#安装Postfix" class="headerlink" title="安装Postfix"></a>安装Postfix</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install postfix </span><br><span class="line">sudo apt-get install mailutils</span><br></pre></td></tr></table></figure>

<p>我这边是按照默认配置安装的。</p>
<h1 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/postfix/main.cf</span><br></pre></td></tr></table></figure>

<p>将<code>myhostname</code>修改为<code>localhost</code></p>
<h1 id="启动Postfix服务"><a href="#启动Postfix服务" class="headerlink" title="启动Postfix服务"></a>启动Postfix服务</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service postfix start</span><br></pre></td></tr></table></figure>

<h1 id="发送"><a href="#发送" class="headerlink" title="发送"></a>发送</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mailx -r root@chengyao.xyz -s &amp;quot;Subject&amp;quot; 987861463@qq.com &amp;lt; ./log.txt</span><br></pre></td></tr></table></figure>

<p>上面步骤没有测试，可行性未知</p>
<p>如果有发送附件但发送失败，可以查看<code>/var/log/mail.log</code>文件，如果是<code>message file too big</code>,可以输入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postconf -e &amp;quot;message_size_limit=409600000&amp;quot;            //设置400MB</span><br></pre></td></tr></table></figure>
<p>将允许的大小改大些。</p>
<h1 id="mailx命令"><a href="#mailx命令" class="headerlink" title="mailx命令"></a>mailx命令</h1><p>mailx命令相关命令的有：mail,sendmail.</p>
<p>语法</p>
<p>mailx [选项] [名字]</p>
<p>说明</p>
<p>本命令用于发送和接收邮件，名字是收信人的用户名，本命令有许多选项，选项说明如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">-A：执行帐户的命令的名称启动文件被读取之后。</span><br><span class="line">-a：给定的文件附加到邮件中。</span><br><span class="line">-B：使标准输入和标准输出线-缓冲。</span><br><span class="line">-b：发送密件副本列表。列表应该是一个逗号分隔的名称列表。</span><br><span class="line">-c：送炭复制到地址列表。</span><br><span class="line">-D：开始在断开模式; 看到断开的变量的描述选项。</span><br><span class="line">-d：启用调试消息和关闭消息的实际交付。 不像-v，此选项仅用于开发目的。</span><br><span class="line">-e：只是检查是否有邮件系统邮箱。 如果是，返回零，否则，一个非零值退出状态。</span><br><span class="line">-E：如果传出消息，不包含在它的第一个或唯一的消息部分的任何文字，不要把它丢弃，但它静静地，有效地设置在程序启动时的skipemptybody变量。这是一个从发送消息有用 的脚本由启动cron的。</span><br><span class="line">-f：阅读在用户的邮箱中的内容（或文件时 ，如果指定）进行处理; 当mailx的是退出，将其写入未删除的邮件恢复该文件。 该字符串作为文件处理描述为文件夹命令如下。</span><br><span class="line">-F：保存要发送的消息中的第一个收件人的地址的本地部分命名的文件。</span><br><span class="line">-H：打印头汇总所有消息并退出。</span><br><span class="line">-h：调用的sendmail与指定的跃点数。此选项没有在使用SMTP发送邮件的效果。</span><br><span class="line">-i：TTY忽略中断信号。使用mailx的对噪音的电话线时，这是非常有用的。</span><br><span class="line">-I：显示了“ 新闻组：&amp;#039;或&amp;#039; 文章ID：&amp;#039;在标题汇总字段。只有在与-f结合使用时适用。</span><br><span class="line">-n：禁止阅读/etc/mail.rc启动时。这个选项应该适用于对多台计算机调用mailx的脚 本来启动，因为文件的内容，它们之间可能有所不同。</span><br><span class="line">-N：阅读邮件或编辑邮件文件夹时禁止消息头的初始显示。</span><br><span class="line">-q：启动与指定的文件的内容的消息。 可仅在发送模式给出。</span><br><span class="line">-r：设置发件人地址。忽略任何从指定的变量环境变量或启动文件。波浪号逃逸被禁用。该-r地址选项被传递到邮件传输代理，除非使用SMTP。此选项存在唯一的相容性;它建议，而不是直接设置从变量。</span><br><span class="line">-R：如果打开文件夹的只读打开它们。</span><br><span class="line">-s：指定主题的命令行（仅后-s标志作为主题的第一个参数，要注意引用包含空格的科目）。</span><br><span class="line">-S：设置内部选项变量变量的可选值的价值 。</span><br><span class="line">-T：写“ 邮件ID：”和“ 文章ID：&amp;#039;读入文件名 ??的每个消息头字段。暗示我压缩文件的处理所描述的文件夹命令如下。</span><br><span class="line">-t：要发送的消息，预计将包含一个消息头“收件人：”，“抄送”或“密件抄送：”字段给收件人。 在命令行上指定的收件人将被忽略。</span><br><span class="line">-u：读取用户的用户的邮箱。</span><br><span class="line">-v：详细模式。 递送的详细信息显示在用户的终端上。</span><br><span class="line">-V：显示版本信息并退出。</span><br><span class="line">- ?：启用波浪逃逸 ，即使不是在交互模式。</span><br></pre></td></tr></table></figure>
<p>命令内说明</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">. 当前信件</span><br><span class="line">n 第 n 封信</span><br><span class="line">^ 第一封未被处理的信</span><br><span class="line">$ 最后一封信</span><br><span class="line">* 所有的信</span><br><span class="line">n-m 第n封至第m封信</span><br><span class="line">/ 字符串 标题中包含字符串的信</span><br><span class="line">：c 满足指定类型c的信，类型可为</span><br><span class="line">d 已删除的信</span><br><span class="line">n 信传送的信</span><br><span class="line">o 旧信件</span><br><span class="line">r 已读过的信</span><br><span class="line">u 未读过的信</span><br><span class="line">p 一次显示多封信</span><br><span class="line">t 显示某封信的前若干行</span><br><span class="line">si 显示信件字符数</span><br><span class="line">h 显示信件标题</span><br><span class="line">d 删除信件</span><br><span class="line">u 恢复信件</span><br><span class="line">s [信件表] 文件名</span><br><span class="line">将信件存入指定文件中</span><br><span class="line">q 退出</span><br><span class="line">r 回信</span><br><span class="line">~e 编辑信件</span><br><span class="line">~r 文件 从文件中读取信件</span><br></pre></td></tr></table></figure>
<p>实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mailx -s &amp;quot;test&amp;quot; -a 1.txt &amp;#039;mytest@ywnz.com&amp;#039; &amp;lt; 2.txt　#test为标题,1.txt附 件,2.txt正文,发送给mytest@123.com</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-06T15:16:37.000Z" title="2021/7/6 下午11:16:37">2021-07-06</time>发表</span><span class="level-item"><time dateTime="2022-08-28T02:23:10.673Z" title="2022/8/28 上午10:23:10">2022-08-28</time>更新</span><span class="level-item">5 分钟读完 (大约803个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/06/SQL%E4%BC%98%E5%8C%96%E7%9B%B8%E5%85%B3%E6%80%BB%E7%BB%93/">SQL优化相关总结</a></h1><div class="content"><h1 id="SQL执行顺序"><a href="#SQL执行顺序" class="headerlink" title="SQL执行顺序"></a>SQL执行顺序</h1><p>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011277123/article/details/54691260">https://blog.csdn.net/u011277123/article/details/54691260</a></p>
<p>#Pgsql 执行计划<br><a target="_blank" rel="noopener" href="http://mysql.taobao.org/monthly/2018/11/06/">http://mysql.taobao.org/monthly/2018/11/06/</a></p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p>在数据库应用中，程序员们通过不断的实践总结了很多经验，这些经验是一些普遍适用的规则。每一个程序员都应该了解并记住它们，在构造SQL语句时，养成良好的习惯。以下10条比较重要的原则供大家参考。</p>
<p>原则1：尽量避免在列上做运算，这样会导致索引失败。例如原句为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM t WHERE YEAR(d) &amp;gt;= 2011;</span><br></pre></td></tr></table></figure>

<p>优化为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM t WHERE ｄ　&amp;gt;= ‘2011-01-01’;</span><br></pre></td></tr></table></figure>

<p>原则2：使用join时，应该用小结果集驱动大结果集。同时把复杂的join查询拆分成多个query。因为join多个表时，可能导致更多的锁定和堵塞。例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> a <span class="keyword">JOIN</span> b <span class="keyword">ON</span> a.id <span class="operator">=</span> b.id</span><br><span class="line"></span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> c <span class="keyword">ON</span> c.time <span class="operator">=</span> a.date</span><br><span class="line"></span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> d <span class="keyword">ON</span> c.pid <span class="operator">=</span> b.aid</span><br><span class="line"></span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> e <span class="keyword">ON</span> e.cid <span class="operator">=</span> a.did</span><br></pre></td></tr></table></figure>

<p>原则3：注意like模糊查询的使用，避免%%。例如原句为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM t WHERE name LIKE ‘%de%’</span><br></pre></td></tr></table></figure>

<p>优化为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM t WHERE name &amp;gt;= ‘de’AND name &amp;lt;= ‘df’</span><br></pre></td></tr></table></figure>

<p>原则4：仅列出需要查询的字段，这对速度不会有明显的影响，主要考虑节省内存。例如原句为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM Member；</span><br></pre></td></tr></table></figure>

<p>优化为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT id,name,pwd FROM Member;</span><br></pre></td></tr></table></figure>

<p>原则5：使用批量插入语句节省交互。例如原句为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO t(id,name)VALUES(1,’a’);</span><br><span class="line"></span><br><span class="line">INSERT INTO t(id,name)VALUES(2,’b’);</span><br><span class="line"></span><br><span class="line">INSERT INTO t(id,name)VALUES(3,’c’);</span><br></pre></td></tr></table></figure>

<p>优化为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO t(id,name)VALUES(1,’a’),(2,’b’),(3,’c’);</span><br></pre></td></tr></table></figure>

<p>原则6：limit的基数比较大的时候使用between。例如原句为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM article AS article RODER BY id LIMIT 1000000,10;</span><br></pre></td></tr></table></figure>

<p>优化为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM article AS article WHERE id BETWEEN 1000000 AND 1000010 RODER BY id;</span><br></pre></td></tr></table></figure>

<p>Between限定比limit快，所以海量数据访问时，建议between或是where替换掉limit。但是between也有缺陷，如果id中间有断行或是中间部分id不读取的情况，总读取的数量会少于预计数量！</p>
<p>在取比较后面的数据时，通过desc方式把数据反向查找，以减少对前段数据的扫描，让limit的基数越小越好！</p>
<p>原则7：不要使用rand()函数获取多条随机记录。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from table order by rand() limit 20;</span><br></pre></td></tr></table></figure>

<p>使用下面的语句代替：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> <span class="operator">*</span> <span class="keyword">from</span> ‘<span class="keyword">table</span>’<span class="keyword">as</span> t1 <span class="keyword">join</span>(<span class="keyword">select</span> rand(rand() <span class="operator">*</span> ((<span class="keyword">select</span> <span class="built_in">max</span>(id) <span class="keyword">from</span> ‘<span class="keyword">table</span>’)<span class="operator">-</span>(<span class="keyword">select</span> <span class="built_in">min</span>(id) <span class="keyword">from</span> ‘<span class="keyword">table</span>’))<span class="operator">+</span>(<span class="keyword">select</span> <span class="built_in">min</span>(id) <span class="keyword">from</span> ‘<span class="keyword">table</span>’))<span class="keyword">as</span> id) <span class="keyword">as</span> t2 <span class="keyword">where</span> t1.id <span class="operator">&amp;</span>gt;<span class="operator">=</span> t2.id <span class="keyword">order</span> <span class="keyword">by</span> t1.id limit <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>这是获取一条随机记录，这样即使执行20次，也比原来的语句高效。或者先用php产生随机数，把这个字符串传给MySQL，MySQL里用in查询。</p>
<p>原则8：避免使用null。</p>
<p>原则9：不要使用count(*)，而应该是count(1)。</p>
<p>原则10：不要做无谓的排序操作，而尽可能在索引中完成排序。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-05T14:49:20.000Z" title="2021/7/5 下午10:49:20">2021-07-05</time>发表</span><span class="level-item"><time dateTime="2022-09-30T13:23:25.975Z" title="2022/9/30 下午9:23:25">2022-09-30</time>更新</span><span class="level-item">1 小时读完 (大约11209个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/05/Mysql%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4%E5%8F%8A%E8%AF%AD%E6%B3%95%E7%AC%94%E8%AE%B0/">Mysql基础命令及语法笔记</a></h1><div class="content"><h1 id="show-命令"><a href="#show-命令" class="headerlink" title="show 命令"></a>show 命令</h1><blockquote>
<p>help show 查看允许的show语句</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> databases</span><br><span class="line"><span class="keyword">show</span> tables</span><br><span class="line"><span class="keyword">show</span> [<span class="keyword">full</span>] columns <span class="keyword">from</span> <span class="operator">&lt;</span><span class="keyword">table</span><span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> database <span class="operator">&lt;</span>name<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">show</span> status</span><br><span class="line"><span class="keyword">show</span> grants</span><br><span class="line"><span class="keyword">show</span> errors</span><br><span class="line"><span class="keyword">show</span> warnings</span><br></pre></td></tr></table></figure>

<h1 id="set-names"><a href="#set-names" class="headerlink" title="set names"></a>set names</h1><p>设置编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set names &#x27;utf8&#x27;;</span><br></pre></td></tr></table></figure>

<h1 id="select"><a href="#select" class="headerlink" title="select"></a>select</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> <span class="operator">&lt;</span><span class="keyword">column</span><span class="operator">&gt;</span> <span class="keyword">from</span> <span class="operator">&lt;</span><span class="keyword">table</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于order by , <code>A</code> 和 <code>a</code> 不一定相同（在mysql中默认相同【字典排序】），取决于数据库怎么设计，通常可以改变这种行为。</p>
</blockquote>
<blockquote>
<p>对于没有排序的语句，返回的结果集的顺序没有特殊意义，又可能按照插入表的顺序，也有可能不是，只要返回总数正确，就是正常的。</p>
</blockquote>
<h2 id="正则"><a href="#正则" class="headerlink" title="正则"></a>正则</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> name REGEXP <span class="type">BINARY</span> <span class="string">&#x27;^cheng.*g$&#x27;</span> <span class="comment">--使用BINARY来区分大小写</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information <span class="keyword">WHERE</span> salary REGEXP <span class="string">&#x27;1000|2000&#x27;</span> <span class="comment">--OR匹配</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> name REGEXT <span class="string">&#x27;[cz]ong&#x27;</span> <span class="comment">-- 单一字符，会匹配cong / zong； 可以使用否定 例如：[^cz]</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>其他支持的正则 [0-9], \\-（特殊字符）-, 也可以用来引用元字符，例如\\f (换页)， \\n （换行），\\r （换行）, \\t （制表）, \\v （纵向制表），\\ （反斜线），多数正则表达式使用单个反斜线转义特殊字符，mysql要求使用两个，一个由mysql解析，另外一个由正则表达式库解析。</p>
</blockquote>
<p>like 也支持binary来区分大小写 <code>like binary</code>, 大小写主要取决于表的校对规则collect</p>
<h3 id="字符类（character-class）"><a href="#字符类（character-class）" class="headerlink" title="字符类（character class）"></a>字符类（character class）</h3><table>
<thead>
<tr>
<th>类</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>[:alnum:]</td>
<td>任意字母和数字.(同[ a-zA-Z0-9])</td>
</tr>
<tr>
<td>[:alpha:]</td>
<td>任意字符（同[ a-zA-Z])</td>
</tr>
<tr>
<td>[:blank:]</td>
<td>空格和制表（同[ \lt])</td>
</tr>
<tr>
<td>[:cntrl:]</td>
<td>ASCII控制字符（ASCII 0到31和127)</td>
</tr>
<tr>
<td>[:digit:]</td>
<td>任意数字（同[0-9])</td>
</tr>
<tr>
<td>[:graph:]</td>
<td>与[ :print : ]相同，但不包括空格</td>
</tr>
<tr>
<td>[:lower:]</td>
<td>任意小写字母(同[ a-z])</td>
</tr>
<tr>
<td>[:print:]</td>
<td>任意可打印字符</td>
</tr>
<tr>
<td>[:punct:]</td>
<td>既不在[ :alnum: ]又不在[ :cntrl: ]中的任意字符</td>
</tr>
<tr>
<td>[:space:]</td>
<td>包括空格在内的任意空白字符（同[ \lf\ln \lrlltllv])</td>
</tr>
<tr>
<td>[:upper:]</td>
<td>任意大写字母(同[A-Z])</td>
</tr>
<tr>
<td>[:xdigit:]</td>
<td>任意十六进制数字（同[ a-fA-FO-9])</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> contracts <span class="keyword">where</span> amount regexp <span class="string">&#x27;[[:digit:]]&#123;2,4&#125;&#x27;</span></span><br><span class="line"><span class="comment">-- 匹配2到四位数字</span></span><br></pre></td></tr></table></figure>

<h3 id="匹配多个实例"><a href="#匹配多个实例" class="headerlink" title="匹配多个实例"></a>匹配多个实例</h3><p>支持<code>*</code>,<code>+</code>, <code>?</code>, <code>&#123;n&#125;</code>, <code>&#123;n,&#125;</code>, <code>&#123;n,m&#125;</code> 其中m不能大于255 （mysql8测试可以输入大于255的数字，但是有没有效果没有测试）</p>
<h3 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h3><table>
<thead>
<tr>
<th>元字符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>^</td>
<td>文本的开始</td>
</tr>
<tr>
<td>$</td>
<td>文本的结尾</td>
</tr>
<tr>
<td>[[:&lt;:]]</td>
<td>词的开始</td>
</tr>
<tr>
<td>[[:&gt;:]]</td>
<td>词的结尾</td>
</tr>
</tbody></table>
<blockquote>
<p>匹配词的边界，兼容perl的正则表达式通常使用\b单词边界 或者\B 非单词边界</p>
</blockquote>
<p>使REGEXP起类似LIKE的作用， LIKE和REGEXP的不同在于、LIKE匹配整个串而REGEXP匹配子串。利用定位符,通过用^开始每个表达式，用$结束每个表达式可以使REGEXP的作用与LIKE一样。</p>
<blockquote>
<p>简单的正则表达式测试可以在不使用数据库表的情况下用SELECT来测试正则表达式。 REGEXP检查总是返回0(没有匹配）或1(匹配）。可以用带文字串的REGEXP来测试表达式，并试验它们。相应的语法如下:</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;hello&#x27;</span> REGEXP <span class="string">&#x27;[0-9]&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="计算字段"><a href="#计算字段" class="headerlink" title="计算字段"></a>计算字段</h2><h3 id="拼接（concatenate）字段或者字符串"><a href="#拼接（concatenate）字段或者字符串" class="headerlink" title="拼接（concatenate）字段或者字符串"></a>拼接（concatenate）字段或者字符串</h3><blockquote>
<p>多数数据库采用<code>||</code>或者<code>+</code> 来拼接，而Mysql使用concat() 函数拼接。</p>
</blockquote>
<h3 id="删除多余空格"><a href="#删除多余空格" class="headerlink" title="删除多余空格"></a>删除多余空格</h3><p><code>rtrim()</code> <code>ltrim()</code> <code>trim()</code></p>
<p><code>AS</code> 别名，可以用来创建一个计算字段，当列名不符合规定的字符例如包含空格的时候可以使用别名代替，在原名易混淆时候扩充它。别名也称作<code>导出列（derivid column）</code></p>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="文本处理函数"><a href="#文本处理函数" class="headerlink" title="文本处理函数"></a>文本处理函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>LEFT(Str,length)</td>
<td>返回串左边的字符</td>
</tr>
<tr>
<td>Length()</td>
<td>返回串的长度</td>
</tr>
<tr>
<td>Locate()</td>
<td>找出一个串的子串</td>
</tr>
<tr>
<td>Lower()</td>
<td>将串转为小写</td>
</tr>
<tr>
<td>Ltrim()</td>
<td>去掉左边的空格</td>
</tr>
<tr>
<td>Right()</td>
<td>返回串右边的字符</td>
</tr>
<tr>
<td>Rtrim()</td>
<td>去掉右边空格</td>
</tr>
<tr>
<td>Soundex()</td>
<td>发音接近</td>
</tr>
<tr>
<td>SubString()</td>
<td>返回子串的字符</td>
</tr>
<tr>
<td>Upper()</td>
<td>将串转为大写</td>
</tr>
<tr>
<td>LOCATE(substr,str)</td>
<td>寻找子串位置，返回数字，0表示没有找到</td>
</tr>
<tr>
<td>LOCATE(substr,str,pos)</td>
<td></td>
</tr>
<tr>
<td>POSITION(substr IN str)</td>
<td></td>
</tr>
<tr>
<td>INSTR(str,substr)</td>
<td></td>
</tr>
<tr>
<td>REVERSE(Str)</td>
<td>翻转</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> party_course_study</span><br><span class="line"><span class="keyword">WHERE</span> LOCATE(findCode, <span class="string">&#x27;00001&#x27;</span>) <span class="operator">&gt;</span><span class="number">0</span></span><br><span class="line"> </span><br><span class="line"><span class="operator">/</span><span class="operator">/</span> 注：Mybatis使用场景，需要加 <span class="operator">&lt;</span><span class="operator">!</span>[CDATA[ ]]<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> party_course_study</span><br><span class="line"><span class="keyword">WHERE</span> <span class="operator">&lt;</span><span class="operator">!</span>[CDATA[ LOCATE(findCode, <span class="string">&#x27;00001&#x27;</span>) <span class="operator">&gt;</span> <span class="number">0</span> ]]<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>


<blockquote>
<p>表中的SOUNDEX需要做进一步的解释。SOUNDEX是一个将任何文本串转换为描述其语音表示的字母数字模式的算法。SOUNDEX考虑了类似的发音字符和音节，使得能对串进行发音比较而不是字母比较。虽然SOUNDEX不是SQL概念，但MySQL（就像多数DBMS一样）都提供对SOUNDEX的支持。</p>
</blockquote>
<h3 id="日期和时间处理函数"><a href="#日期和时间处理函数" class="headerlink" title="日期和时间处理函数"></a>日期和时间处理函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>AddDate()</td>
<td>增加一个日期（天、周等）</td>
</tr>
<tr>
<td>AddTime()</td>
<td>增加一个时间（时、分等）</td>
</tr>
<tr>
<td>CurDate()</td>
<td>返回当前日期</td>
</tr>
<tr>
<td>CurTime ()</td>
<td>返回当前时间</td>
</tr>
<tr>
<td>Date()</td>
<td>返回日期时间的日期部分</td>
</tr>
<tr>
<td>DateDiff ()</td>
<td>计算两个日期之差</td>
</tr>
<tr>
<td>Date_Add()</td>
<td>高度灵活的日期运算函数</td>
</tr>
<tr>
<td>Date Format ()</td>
<td>返回一个格式化的日期或时间串</td>
</tr>
<tr>
<td>Day()</td>
<td>返回一个日期的天数部分</td>
</tr>
<tr>
<td>DayOfWeek()</td>
<td>对千一个日期， 返回对应的星期几</td>
</tr>
<tr>
<td>Hour()</td>
<td>返回一个时间的小时部分</td>
</tr>
<tr>
<td>minute()</td>
<td>返回一个时间的分钟部分</td>
</tr>
<tr>
<td>Month ()</td>
<td>返回一个日期的月份部分</td>
</tr>
<tr>
<td>Now()</td>
<td>返回当前日期和时间</td>
</tr>
<tr>
<td>Second()</td>
<td>返回一个时间的秒部分</td>
</tr>
<tr>
<td>Time ()</td>
<td>返回一个日期时间的时间部分</td>
</tr>
<tr>
<td>Year()</td>
<td>返回一个日期的年份部分</td>
</tr>
<tr>
<td>DATE_FORMAT(CURDATE(),’%Y%m’)</td>
<td>结果为当前年和月</td>
</tr>
<tr>
<td>CURRENT_TIMESTAM</td>
<td>当前时间戳</td>
</tr>
<tr>
<td>CURRENT_TIME</td>
<td>当前时间</td>
</tr>
<tr>
<td>CURRENT_DATE</td>
<td>当前日期</td>
</tr>
</tbody></table>
<p>mysql查询今天、昨天、本周、本月、上一月 、今年数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">--今天</span><br><span class="line"></span><br><span class="line">select * from 表名 where to_days(时间字段名) = to_days(now());</span><br><span class="line"></span><br><span class="line">--昨天</span><br><span class="line"></span><br><span class="line">SELECT * FROM 表名 WHERE TO_DAYS( NOW( ) ) - TO_DAYS( 时间字段名) &amp;lt;= 1</span><br><span class="line"></span><br><span class="line">--本周</span><br><span class="line"></span><br><span class="line">SELECT * FROM  表名 WHERE YEARWEEK( date_format(  时间字段名,&#x27;%Y-%m-%d&#x27; ) ) = YEARWEEK( now() ) ;</span><br><span class="line"></span><br><span class="line">--本月</span><br><span class="line"></span><br><span class="line">SELECT * FROM  表名 WHERE DATE_FORMAT( 时间字段名, &#x27;%Y%m&#x27; ) = DATE_FORMAT( CURDATE( ) ,&#x27;%Y%m&#x27; ) </span><br><span class="line"></span><br><span class="line">--上一个月</span><br><span class="line"></span><br><span class="line">SELECT * FROM  表名 WHERE PERIOD_DIFF(date_format(now(),&#x27;%Y%m&#x27;),date_format(时间字段名,&#x27;%Y%m&#x27;) =1</span><br><span class="line"></span><br><span class="line">--本年</span><br><span class="line"></span><br><span class="line">SELECT * FROM 表名 WHERE YEAR(  时间字段名 ) = YEAR( NOW( ) ) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--上一月</span><br><span class="line"></span><br><span class="line">SELECT * FROM 表名 WHERE PERIOD_DIFF( date_format( now( ) , &#x27;%Y%m&#x27; ) , date_format( 时间字段名, &#x27;%Y%m&#x27; ) ) =1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--查询本季度数据</span><br><span class="line">select * from `ht_invoice_information` where QUARTER(create_date)=QUARTER(now());</span><br><span class="line">--查询上季度数据</span><br><span class="line">select * from `ht_invoice_information` where QUARTER(create_date)=QUARTER(DATE_SUB(now(),interval 1 QUARTER));</span><br><span class="line">--查询本年数据</span><br><span class="line">select * from `ht_invoice_information` where YEAR(create_date)=YEAR(NOW());</span><br><span class="line">--查询上年数据</span><br><span class="line">select * from `ht_invoice_information` where year(create_date)=year(date_sub(now(),interval 1 year));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--查询当前这周的数据 </span><br><span class="line">SELECT name,submittime FROM enterprise WHERE YEARWEEK(date_format(submittime,&#x27;%Y-%m-%d&#x27;)) = YEARWEEK(now());</span><br><span class="line"></span><br><span class="line">--查询上周的数据</span><br><span class="line">SELECT name,submittime FROM enterprise WHERE YEARWEEK(date_format(submittime,&#x27;%Y-%m-%d&#x27;)) = YEARWEEK(now())-1;</span><br><span class="line"></span><br><span class="line">--查询当前月份的数据</span><br><span class="line">select name,submittime from enterprise   where date_format(submittime,&#x27;%Y-%m&#x27;)=date_format(now(),&#x27;%Y-%m&#x27;)</span><br><span class="line"></span><br><span class="line">--查询距离当前现在6个月的数据</span><br><span class="line">select name,submittime from enterprise where submittime between date_sub(now(),interval 6 month) and now();</span><br><span class="line"></span><br><span class="line">--查询上个月的数据</span><br><span class="line">select name,submittime from enterprise   where date_format(submittime,&#x27;%Y-%m&#x27;)=date_format(DATE_SUB(curdate(), INTERVAL 1 MONTH),&#x27;%Y-%m&#x27;)</span><br><span class="line"></span><br><span class="line">select * from ` user ` where DATE_FORMAT(pudate, &#x27; %Y%m &#x27; ) = DATE_FORMAT(CURDATE(), &#x27; %Y%m &#x27; ) ;</span><br><span class="line"></span><br><span class="line">select * from user where WEEKOFYEAR(FROM_UNIXTIME(pudate,&#x27;%y-%m-%d&#x27;)) = WEEKOFYEAR(now())</span><br><span class="line"></span><br><span class="line">select * </span><br><span class="line">from user </span><br><span class="line">where MONTH (FROM_UNIXTIME(pudate, &#x27; %y-%m-%d &#x27; )) = MONTH (now())</span><br><span class="line"></span><br><span class="line">select * </span><br><span class="line">from [ user ] </span><br><span class="line">where YEAR (FROM_UNIXTIME(pudate, &#x27; %y-%m-%d &#x27; )) = YEAR (now())</span><br><span class="line">and MONTH (FROM_UNIXTIME(pudate, &#x27; %y-%m-%d &#x27; )) = MONTH (now())</span><br><span class="line"></span><br><span class="line">select * </span><br><span class="line">from [ user ] </span><br><span class="line">where pudate between 上月最后一天</span><br><span class="line">and 下月第一天</span><br><span class="line"></span><br><span class="line">where   date(regdate)   =   curdate();</span><br><span class="line"></span><br><span class="line">select   *   from   test   where   year(regdate)=year(now())   and   month(regdate)=month(now())   and   day(regdate)=day(now())</span><br><span class="line"></span><br><span class="line">SELECT date( c_instime ) ,curdate( )</span><br><span class="line">FROM `t_score`</span><br><span class="line">WHERE 1</span><br><span class="line">LIMIT 0 , 30</span><br></pre></td></tr></table></figure>

<h3 id="数值处理函数"><a href="#数值处理函数" class="headerlink" title="数值处理函数"></a>数值处理函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Abs ()</td>
<td>返回一个数的绝对值</td>
</tr>
<tr>
<td>Cos ()</td>
<td>返回一个角度的余弦</td>
</tr>
<tr>
<td>Exp ()</td>
<td>返回一个数的指数值</td>
</tr>
<tr>
<td>Mod ()</td>
<td>返回除操作的余数</td>
</tr>
<tr>
<td>Pi（）</td>
<td>返回圆周率</td>
</tr>
<tr>
<td>Rand ()</td>
<td>返回一个随机数</td>
</tr>
<tr>
<td>Sin ()</td>
<td>返回一个角度的正弦</td>
</tr>
<tr>
<td>Sqrt()</td>
<td>返回一个数的平方根</td>
</tr>
<tr>
<td>Tan ()</td>
<td>返回一个角度的正切</td>
</tr>
</tbody></table>
<h2 id="聚集函数"><a href="#聚集函数" class="headerlink" title="聚集函数"></a>聚集函数</h2><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>AVG()</td>
<td>返回某列的平均值</td>
</tr>
<tr>
<td>COUNT()</td>
<td>返回某列的行数</td>
</tr>
<tr>
<td>MAX()</td>
<td>返回某列的最大值</td>
</tr>
<tr>
<td>MIN()</td>
<td>返回某列的最小值</td>
</tr>
<tr>
<td>SUM()</td>
<td>返回某列值之和</td>
</tr>
</tbody></table>
<blockquote>
<p>不可以使用distinct <em>, count(</em>) 包含null，count(字段) 不包含null，；利用标准运算符，所有的聚集函数都可以执行多个列的运算</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> cid) <span class="keyword">from</span> notes;</span><br></pre></td></tr></table></figure>

<p>聚合函数可以聚合多个列的计算值，例如</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">sum</span>(price <span class="operator">*</span> stock) <span class="keyword">from</span> products;</span><br></pre></td></tr></table></figure>

<h2 id="concat系列函数"><a href="#concat系列函数" class="headerlink" title="concat系列函数"></a>concat系列函数</h2><h3 id="concat"><a href="#concat" class="headerlink" title="concat"></a>concat</h3><p><strong>mysql</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select concat(id, name) as id_and_name from users;</span><br></pre></td></tr></table></figure>

<p>返回两个字段拼接的值，如果有一个字段的值为null，则返回null</p>
<p><strong>oracle, psql</strong></p>
<p>可以使用<code>||</code>来分割，例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id || name as id_and_name from users;</span><br></pre></td></tr></table></figure>

<p>好像是上面这么写的，好久没用了。</p>
<h3 id="concat-ws"><a href="#concat-ws" class="headerlink" title="concat_ws"></a>concat_ws</h3><blockquote>
<p>concat with separator, 使用分隔符分割</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select concat_ws(&#x27;,&#x27;, id, name) as id_and_name from users;</span><br></pre></td></tr></table></figure>

<p>返回结果例如，分隔符如果为null则返回null</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id = 1, name = 2</span><br><span class="line">id_and_name 1,2</span><br></pre></td></tr></table></figure>

<h3 id="group-concat"><a href="#group-concat" class="headerlink" title="group_concat"></a>group_concat</h3><ul>
<li>功能：将<code>group by</code>产生的同一个分组中的值连接起来，返回一个字符串结果。</li>
<li>语法：<code>group_concat( [distinct] 要连接的字段 [order by 排序字段 asc/desc ] [separator &#39;分隔符&#39;])</code></li>
</ul>
<blockquote>
<p>在有group by的查询语句中，select指定的字段要么就包含在group by语句的后面，作为分组的依据，要么就包含在聚合函数中</p>
</blockquote>
<p>例如，查询相同姓名中年龄最小的用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select name, min(age) from users group by name;</span><br></pre></td></tr></table></figure>

<p>如果要查出所有</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select name, age from users order by age;</span><br></pre></td></tr></table></figure>

<p>则name可能重复，可以使用group_concat</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select name, group_concat(age) from users group by name; </span><br></pre></td></tr></table></figure>

<h2 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h2><p><code>group by</code> 必须出现在<code>where</code>之后<code>order by</code>之前</p>
<p>使用<code>with rollup</code> 可以获取分组汇总级别</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(id), id <span class="keyword">from</span> users <span class="keyword">group</span> <span class="keyword">by</span> id <span class="keyword">with</span> <span class="keyword">rollup</span>;</span><br></pre></td></tr></table></figure>

<p>我们经常发现用GROUP BY分组的数据确实是以分组顺序输出的。但情况并不总是这样，它并不是SQL规范所要求的。此外，用户也可能会要求以不同于分组的顺序排序。仅因为你以某种方式分组数据（获得特定的分组聚集值)，并不表示你需要以相同的方式排序输出。应该提供明确的ORDER BY子句，即使其效果等同于GROUP BY子句也是如此。</p>
<blockquote>
<p>不要忘记ORDER BY一般在使用GROUP BY子句时，应该也给出ORDER BY子句。这是保证数据正确排序的唯一方法。千万不要仅依赖GROUP BY排序数据。</p>
</blockquote>
<h1 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h1><h2 id="随机排序"><a href="#随机排序" class="headerlink" title="随机排序"></a>随机排序</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">order by rand()</span><br></pre></td></tr></table></figure>

<h2 id="取消排序"><a href="#取消排序" class="headerlink" title="取消排序"></a>取消排序</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">order by null </span><br></pre></td></tr></table></figure>

<h2 id="自定义排序"><a href="#自定义排序" class="headerlink" title="自定义排序"></a>自定义排序</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">order by field(id, 1,3,4)</span><br></pre></td></tr></table></figure>

<p>根据id自定义排序，如果id是null或者不存在于后面的列表中则排序为0，否则按照后面给定的排序进行排序</p>
<h1 id="SQL子句顺序"><a href="#SQL子句顺序" class="headerlink" title="SQL子句顺序"></a>SQL子句顺序</h1><table>
<thead>
<tr>
<th>子句</th>
<th>说明</th>
<th>是否必须使用</th>
</tr>
</thead>
<tbody><tr>
<td>SELECT</td>
<td>要返回的列或表达式</td>
<td>是</td>
</tr>
<tr>
<td>FROM</td>
<td>从中检索数据的表</td>
<td>仅在从表选择数据时使用</td>
</tr>
<tr>
<td>WHERE</td>
<td>行级过滤</td>
<td>否</td>
</tr>
<tr>
<td>GROUP BY</td>
<td>分组说明</td>
<td>仅在按组计算聚集时使用</td>
</tr>
<tr>
<td>HAVING</td>
<td>组级过滤</td>
<td>否</td>
</tr>
<tr>
<td>ORDER BY</td>
<td>输出排序顺序</td>
<td>否</td>
</tr>
<tr>
<td>LIMIT</td>
<td>要检索的行数</td>
<td>否</td>
</tr>
</tbody></table>
<h1 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> maker <span class="keyword">where</span> country_id <span class="keyword">in</span> (<span class="keyword">select</span> country_id <span class="keyword">from</span> country);</span><br></pre></td></tr></table></figure>

<h1 id="联表"><a href="#联表" class="headerlink" title="联表"></a>联表</h1><p>自联结<br>内联<br>外联【左，右】<br>full join</p>
<h1 id="组合查询"><a href="#组合查询" class="headerlink" title="组合查询"></a>组合查询</h1><p>union 会去除重复行<br>union all 不会去除重复行</p>
<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><p>禁用、启用索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> users disable keys; <span class="comment">--禁用</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> users enable keys; <span class="comment">--启用</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在批量插入数据之前禁用索引，插入完成后启用索引</p>
</blockquote>
<h2 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h2><h3 id="添加PRIMARY-KEY（主键索引）"><a href="#添加PRIMARY-KEY（主键索引）" class="headerlink" title="添加PRIMARY KEY（主键索引）"></a>添加PRIMARY KEY（主键索引）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE `table_name` ADD PRIMARY KEY ( `column` ) </span><br></pre></td></tr></table></figure>

<h3 id="添加UNIQUE-唯一索引"><a href="#添加UNIQUE-唯一索引" class="headerlink" title="添加UNIQUE(唯一索引)"></a>添加UNIQUE(唯一索引)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE `table_name` ADD UNIQUE ( `column` ) </span><br></pre></td></tr></table></figure>

<h3 id="添加INDEX-普通索引"><a href="#添加INDEX-普通索引" class="headerlink" title="添加INDEX(普通索引)"></a>添加INDEX(普通索引)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE `table_name` ADD INDEX index_name ( `column` ) </span><br></pre></td></tr></table></figure>

<h3 id="添加FULLTEXT-全文索引"><a href="#添加FULLTEXT-全文索引" class="headerlink" title="添加FULLTEXT(全文索引)"></a>添加FULLTEXT(全文索引)</h3><h4 id="建表时建立"><a href="#建表时建立" class="headerlink" title="建表时建立"></a>建表时建立</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> article ( </span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY, </span><br><span class="line">    title <span class="type">VARCHAR</span>(<span class="number">200</span>), </span><br><span class="line">    body TEXT, </span><br><span class="line">    FULLTEXT(title, body) </span><br><span class="line">) TYPE<span class="operator">=</span>MYISAM; </span><br></pre></td></tr></table></figure>

<h4 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `table_name` <span class="keyword">ADD</span> FULLTEXT INDEX index_name( `<span class="keyword">column</span>`, `column2`); </span><br></pre></td></tr></table></figure>

<h4 id="直接添加"><a href="#直接添加" class="headerlink" title="直接添加"></a>直接添加</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> FULLTEXT INDEX index_name(`<span class="keyword">column</span>`) <span class="keyword">on</span> `table_name`;</span><br></pre></td></tr></table></figure>

<h3 id="添加多列索引"><a href="#添加多列索引" class="headerlink" title="添加多列索引"></a>添加多列索引</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `table_name` <span class="keyword">ADD</span> INDEX index_name ( `column1`, `column2`, `column3` )</span><br></pre></td></tr></table></figure>

<h2 id="修改索引"><a href="#修改索引" class="headerlink" title="修改索引"></a>修改索引</h2><p>mysql中没有真正意义上的修改索引，只有先删除之后在创建新的索引才可以达到修改的目的，原因是mysql在创建索引时会对字段建立关系长度等，只有删除之后创建新的索引才能创建新的关系保证索引的正确性；</p>
<p>如：将login_name_index索引修改为单唯一索引；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DROP INDEX login_name_index ON `user`; </span><br><span class="line">ALTER TABLE `user` ADD UNIQUE login_name_index ( `login_name` );</span><br></pre></td></tr></table></figure>

<h2 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h2><p>格式：<code>DROP INDEX</code> 索引名称 <code>ON</code> 表名;</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> INDEX login_name_index <span class="keyword">ON</span> <span class="string">&#x27;user&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `table_name` <span class="keyword">DROP</span> INDEX <span class="string">&#x27;index_name&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="查询索引"><a href="#查询索引" class="headerlink" title="查询索引"></a>查询索引</h2><p>格式：SHOW INDEX FROM 表名;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW INDEX FROM `user`;</span><br></pre></td></tr></table></figure>


<h2 id="全文索引"><a href="#全文索引" class="headerlink" title="全文索引"></a>全文索引</h2><p>全文本搜索时，MySQL不需要分别查看每个行，不需要分别分析和处理每个词。MySQL创建指定列中各词的-一个索引，搜索可以针对这些词进行。这样，MySQL可以快速有效地决定哪些词匹配(哪些行包含它们)，哪些词不匹配，它们匹配的频率，等等。</p>
<blockquote>
<p>Mysql5.7之后innodb引擎也支持全文索引</p>
</blockquote>
<p>通常在建表的时候添加fulltext索引，例如</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> notes (</span><br><span class="line">	title text,</span><br><span class="line">	fulltext(title)</span><br><span class="line">)engine<span class="operator">=</span>myisam;</span><br></pre></td></tr></table></figure>

<p>也可以使用<code>create index</code> 或者<code>alter table</code>来添加索引</p>
<blockquote>
<p>match() against() 还可以作为一个列，</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select match(title) against(&#x27;rabbit&#x27;) as sc from notes;</span><br></pre></td></tr></table></figure>

<p>sc 表示全文检索的计算出的等级值</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/suo082407128/article/details/82663113">MySQL使用全文索引(fulltext index)_椰汁菠萝-CSDN博客_fulltext index</a></p>
<blockquote>
<p>使用全文索引需要注意的是：(基本单位是词)， MySQL默认的分词是所有非字母和数字的特殊符号都是分词符</p>
</blockquote>
<p>使用Match() 和 Against() 来使用全文索引进行检索</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> note_text <span class="keyword">from</span> notes <span class="keyword">where</span> <span class="keyword">match</span>(note_text) against(<span class="string">&#x27;book&#x27;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>match() 可以包含多个列，例如match(title,content) , 应该和建立索引时候的顺序一致</p>
<p> 当查询多列数据时，建议在此多列数据上创建一个联合的全文索引，否则使用不了索引的</p>
</blockquote>
<p>检索的文本越靠前，等级值越大。如果包含多个搜索项，则包含多个匹配词的行的等级值更高</p>
<h2 id="查询扩展"><a href="#查询扩展" class="headerlink" title="查询扩展"></a>查询扩展</h2><p>扫描步骤如下：</p>
<ol>
<li>全文检索，筛选结果行</li>
<li>检查匹配行，选择有用词</li>
<li>再次全文检索，包含上个步骤选择词</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> note_text <span class="keyword">from</span> notes <span class="keyword">where</span> <span class="keyword">match</span>(note_text) against(<span class="string">&#x27;book&#x27;</span> <span class="keyword">with</span> query expansion);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>记录越多，文本越多，使用查询扩展返回的结果越好</p>
</blockquote>
<h2 id="布尔全文检索"><a href="#布尔全文检索" class="headerlink" title="布尔全文检索"></a>布尔全文检索</h2><blockquote>
<p>即使没有fulltext索引也可以使用，但是比较慢且性能差</p>
</blockquote>
<p>关键点：</p>
<ul>
<li>要匹配的词</li>
<li>要排除的词（即使有匹配到的词也会排除掉）</li>
<li>排列提示（指定一些更重要的词，越重要的词等级越高）</li>
<li>表达式分组</li>
<li>其他</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--匹配heavy 排除rope*（rope开头的词）</span></span><br><span class="line"><span class="keyword">SELECT</span> note_ text <span class="keyword">FROM</span> productnotes <span class="keyword">WHERE</span> <span class="keyword">Match</span>(note_ text) Agai nst( <span class="string">&#x27;heavy -rope*&#x27;</span> <span class="keyword">IN</span> <span class="type">BOOLEAN</span> MODE);</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>布尔操作符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>+</td>
<td>包含，词必须存在</td>
</tr>
<tr>
<td>-</td>
<td>排除，词必须不出现</td>
</tr>
<tr>
<td>&gt;</td>
<td>包含且增加等级值</td>
</tr>
<tr>
<td>&lt;</td>
<td>包含且减少等级值</td>
</tr>
<tr>
<td>（）</td>
<td>把词组成子表达式，允许这些组表达式作为一个组被包含，排除，排列等</td>
</tr>
<tr>
<td>~</td>
<td>取消一个词的排序值</td>
</tr>
<tr>
<td>*</td>
<td>词尾的通配符</td>
</tr>
<tr>
<td>“”</td>
<td>定义一个短语，它匹配整个短语</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> note_text <span class="keyword">FROM</span> productnotes <span class="keyword">WHERE</span> <span class="keyword">Match</span>(note_text) Against(<span class="string">&#x27;+rabbit +bait&#x27;</span><span class="keyword">IN</span> <span class="type">BOOLEAN</span> MODE);</span><br><span class="line"><span class="comment">--这个搜索匹配包含词rabbit和bait的行。</span></span><br><span class="line"><span class="keyword">SELECT</span> note_text <span class="keyword">FROM</span> productnotes <span class="keyword">WHERE</span> <span class="keyword">Match</span>(note_text) Against(<span class="string">&#x27;rabbit bait&#x27;</span><span class="keyword">IN</span> <span class="type">BOOLEAN</span> MODE); </span><br><span class="line"><span class="comment">--没有指定操作符，这个搜索匹配包含rabbit和bait中的至少一个词的行。</span></span><br><span class="line"><span class="keyword">SELECT</span> note_text <span class="keyword">FROM</span> productnotes <span class="keyword">WHERE</span> <span class="keyword">Match</span>(note_text) Against(<span class="string">&#x27;&quot;rabbit bait&quot;&#x27;</span><span class="keyword">IN</span> <span class="type">BOOLEAN</span> MODE); </span><br><span class="line"><span class="comment">--这个搜索匹配短语rabbitbait而不是匹配两个词rabbit和bait。</span></span><br><span class="line"><span class="keyword">SELECT</span> note_text <span class="keyword">FROM</span> productnotes <span class="keyword">WHERE</span> <span class="keyword">Match</span>(note_text) Against(<span class="string">&#x27;&gt;rabbit &lt;carrot&#x27;</span><span class="keyword">IN</span> <span class="type">BOOLEAN</span> MODE); </span><br><span class="line"><span class="comment">--匹配rabbit和carrot,增加前者的等级，降低后者的等级。</span></span><br><span class="line"><span class="keyword">SELECT</span> note_text <span class="keyword">FROM</span> productnotes <span class="keyword">WHERE</span> <span class="keyword">Match</span> (note_text) Against(<span class="string">&#x27;+safe +(&lt;Combination)&#x27;</span><span class="keyword">IN</span> <span class="type">BOOLEAN</span> MODE); </span><br><span class="line"><span class="comment">--这个搜索匹配词safe和combination,降低后者的等级。</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>扩展</p>
</blockquote>
<ul>
<li>在索引全文本数据时，短词被忽略且从索引中排除。短词定义为那些具有3个或3个以下字符的词(如果需要,这个数目可以更改)。</li>
<li>MySQL带有一个内建的非用词(stopword) 列表，这些词在索引全文本数据时总是被忽略。如果需要，可以覆盖这个列表(请参阅MySQL文档以了解如何完成此工作)。</li>
<li>许多词出现的频率很高，搜索它们没有用处(返回太多的结果)。因此，MySQL规定了一条50%规则，如果-一个词出现在50%以上的行中，则将它作为一个非用词忽略。50%规则不用于IN BOOLEAN MODE。</li>
<li>如果表中的行数少于3行，则全文本搜索不返回结果(因为每个词或者不出现，或者至少出现在50%的行中)。</li>
<li>忽略词中的单引号。例如，don’t索 引为dont。</li>
<li>不具有词分隔符(包括日语和汉语)的语言不能恰当地返回全文本搜索结果。</li>
</ul>
<p><strong>邻近操作符</strong></p>
<h1 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h1><h2 id="使用视图的优势："><a href="#使用视图的优势：" class="headerlink" title="使用视图的优势："></a>使用视图的优势：</h2><ol start="2">
<li>重用SQL语句</li>
<li>简化复杂的SQL</li>
<li>使用表的组成部分而不是整个表，因此可以作保保护数据即授予表特定部分的访问权限，而不是整个表</li>
<li>更改数据格式，视图可以返回与底层表示和格式不同的数据</li>
</ol>
<p>视图本身不包含数据，使用视图实际上是使用视图的查询规则检索数据。如果修改源表的数据，视图中查询到的数据也会被修改。</p>
<blockquote>
<p>可以通过视图修改数据</p>
</blockquote>
<h2 id="视图创建的规则和限制"><a href="#视图创建的规则和限制" class="headerlink" title="视图创建的规则和限制"></a>视图创建的规则和限制</h2><ol>
<li>视图名不可与其他视图或表名重复</li>
<li>创建视图数量没有限制</li>
<li>创建视图必须有相应访问权限</li>
<li>视图可以嵌套（使用视图再创建视图）</li>
<li>ORDER BY可以在视图中使用，但是如果检索的SQL中有ORDER BY则视图中的被覆盖</li>
<li>视图不能索引，也不能有关联的触发器或者默认值</li>
<li>视图可以和表一起使用</li>
</ol>
<h2 id="使用视图"><a href="#使用视图" class="headerlink" title="使用视图"></a>使用视图</h2><h3 id="创建视图"><a href="#创建视图" class="headerlink" title="创建视图"></a>创建视图</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> <span class="operator">&lt;</span>view_name<span class="operator">&gt;</span> <span class="keyword">as</span> <span class="operator">&lt;</span>dql<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="查看创建视图语句"><a href="#查看创建视图语句" class="headerlink" title="查看创建视图语句"></a>查看创建视图语句</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">view</span> <span class="operator">&lt;</span>view_name<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="删除视图"><a href="#删除视图" class="headerlink" title="删除视图"></a>删除视图</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">view</span> <span class="operator">&lt;</span>view_name<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="修改视图"><a href="#修改视图" class="headerlink" title="修改视图"></a>修改视图</h3><p>可以先删除视图在创建，也可以</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> repace <span class="keyword">view</span> <span class="operator">&lt;</span>view_name<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>视图可以更新，但是如果Mysql认为基数据不能被正确更新，则不会更新，在以下情况下不会更新</p>
</blockquote>
<ul>
<li>分组 group by 和having</li>
<li>联结</li>
<li>子查询</li>
<li>并</li>
<li>聚集函数</li>
<li>Distinct</li>
<li>导出（计算）列</li>
</ul>
<blockquote>
<p>上面的情况可能随着版本不同而有差异，一般情况下视图用来检索</p>
</blockquote>
<h1 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h1><h2 id="使用存储过程"><a href="#使用存储过程" class="headerlink" title="使用存储过程"></a>使用存储过程</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> procedure_name(<span class="variable">@in</span>, <span class="variable">@out</span>)</span><br></pre></td></tr></table></figure>

<h2 id="创建存储过程"><a href="#创建存储过程" class="headerlink" title="创建存储过程"></a>创建存储过程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create procedure procedure_name() comment &#x27;procedure comment&#x27;</span><br><span class="line">begin</span><br><span class="line">select * from notes;</span><br><span class="line">end;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意要先使用\d $ 或者delimiter $将分隔符;临时更改为$或者其他字符</p>
</blockquote>
<p>其中<code>()</code>中可接受参数，begin, end 包含的为存储过程体</p>
<p>可以使用参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create procedure get_username(in id int, out name varchar(10))</span><br><span class="line">begin</span><br><span class="line">select `username` into name from users where `id` = id;</span><br><span class="line">end;</span><br><span class="line">--没有测试，正确性未知</span><br></pre></td></tr></table></figure>

<blockquote>
<p>所有变量都必须以@开始</p>
</blockquote>
<p>调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call get_username(1, @ret);</span><br></pre></td></tr></table></figure>

<p>查询执行返回值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select @ret;</span><br></pre></td></tr></table></figure>

<h3 id="定义变量"><a href="#定义变量" class="headerlink" title="定义变量"></a>定义变量</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> total <span class="type">decimal</span>(<span class="number">8</span>,<span class="number">2</span>) <span class="keyword">default</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h3 id="判断"><a href="#判断" class="headerlink" title="判断"></a>判断</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if <span class="operator">&lt;</span>variable<span class="operator">&gt;</span> <span class="keyword">then</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users;</span><br><span class="line"><span class="keyword">end</span> if;</span><br></pre></td></tr></table></figure>

<p>查看存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">procedure</span> status [<span class="keyword">like</span> <span class="string">&#x27;keywords&#x27;</span>];</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">procedure</span> <span class="operator">&lt;</span>procudure_name<span class="operator">&gt;</span>;</span><br></pre></td></tr></table></figure>

<h1 id="游标"><a href="#游标" class="headerlink" title="游标"></a>游标</h1><blockquote>
<p>MySQL游标不同于其他多数DBMS， 只能用于存储过程和函数 【早期资料】</p>
</blockquote>
<h2 id="使用游标"><a href="#使用游标" class="headerlink" title="使用游标"></a>使用游标</h2><ul>
<li>使用游标前应该先声明（定义），这个过程实际没有检索数据，只是定义要使用的SELECT 语句</li>
<li>一旦声明后，应该打开游标来使用，这个过程用前面定义的SELECT 语句把数据检索出来</li>
<li>对于填有数据的游标，根据需要取出（检索）各行</li>
<li>结束后必须关闭游标</li>
</ul>
<p>声明游标后，可以频繁地打开或者关闭游标，游标打开后，可以频繁地执行取操作</p>
<h3 id="创建游标"><a href="#创建游标" class="headerlink" title="创建游标"></a>创建游标</h3><p><strong>使用declare 定义游标</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">declare products_f cursor for select * from products order by id;</span><br></pre></td></tr></table></figure>

<p><strong>定义游标之后可以打开游标</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open products_f;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>open 语句执行查询，存储检索到地数据以提供浏览和滚动。</p>
</blockquote>
<p><strong>游标处理完成，应该关闭游标</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">close products_f;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>关闭游标会释放游标所使用地内存等资源，所以当游标不再需要使用地时候就应该关闭游标，如果你不明确关闭游标，MySQL会在end语句时关闭游标。</p>
</blockquote>
<p><strong>使用游标数据</strong></p>
<p>游标被打开后，可以使用fetch语句访问它的每一行。fetch指定检索所需的列，数据存放位置，还会向前移动游标内部指针，使下一条fetch语句检索下一行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetch products_f into o;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>检索游标中结果的第一行并将数据存放到局部变量o中，再次执行fetch将检索下一行，除了使用repeat ,还可以使用其他循环语句来重复执行，直到使用leave手动退出，通常repeat的语法更适合对游标进行循环。</p>
</blockquote>
<p><strong>例子</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> products_p()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">declare</span> done <span class="type">boolean</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">declare</span> o <span class="type">int</span>;</span><br><span class="line">	<span class="keyword">declare</span> products_f <span class="keyword">cursor</span> </span><br><span class="line">	<span class="keyword">for</span> </span><br><span class="line">	<span class="keyword">select</span> id <span class="keyword">from</span> users;</span><br><span class="line">	<span class="comment">-- continue handler 条件出现时被执行的代码 即 SQLSTATE &#x27;02000&#x27;出现时执行set done = 1</span></span><br><span class="line">	<span class="comment">-- SQLSTATE &#x27;02000&#x27;是一个未找到条件，即没有更多行时候不再循环 ，更多错误代码列可以查看MySQL手册https://dev.mysql.com/doc/refman/8.0/en/error-handling.html</span></span><br><span class="line">	<span class="keyword">declare</span> continue handler <span class="keyword">for</span> <span class="keyword">SQLSTATE</span> <span class="string">&#x27;02000&#x27;</span> <span class="keyword">set</span> done <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">open</span> products_f;</span><br><span class="line">	<span class="comment">-- 反复执行知道done为真</span></span><br><span class="line">	repeat</span><br><span class="line">		<span class="keyword">fetch</span> products_f <span class="keyword">into</span> o;</span><br><span class="line">	until done <span class="keyword">end</span> repeat;</span><br><span class="line">	<span class="keyword">close</span> products_f;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p> DECLARE语句的次序： DECLARE语句的发布存在特定的次序。用DECLARE语句定义的局部变量必须在定义任意游标或句柄之前定义，而句柄必须在游标之后定义，不遵守此顺序将产生错误消息。</p>
</blockquote>
<h1 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h1><p>MySQL响应delete, insert, update语句而执行触发的一条SQL或位于begin, end 之间的一组SQL。其他MySQL语句不支持触发器。</p>
<h2 id="创建触发器"><a href="#创建触发器" class="headerlink" title="创建触发器"></a>创建触发器</h2><p>创建触发器需要提供以下信息</p>
<ul>
<li>唯一的触发器名</li>
<li>触发器关联的表</li>
<li>触发器应该响应的活动（delete, insert, update）</li>
<li>触发器何时执行（前或者后）</li>
</ul>
<blockquote>
<p>触发器名必须在每个表中唯一，而在每个数据库中不一定唯一。这在其它DBMS中是不允许的。最好是在同一个数据库中保持触发器名唯一</p>
</blockquote>
<p>使用<code>create trigger</code> 创建触发器</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> get_id after <span class="keyword">insert</span> <span class="keyword">on</span> users <span class="keyword">for</span> <span class="keyword">each</span> <span class="type">row</span> <span class="keyword">select</span> <span class="string">&#x27;insert&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>其中for each row 表示代码对每个插入执行</p>
<blockquote>
<p>只有表支持触发器，视图不支持，每个表每个事件只允许一个触发器，因此每个表支支持6个触发器（insert, update, delete 前后 ）。 如果before触发器执行失败，则MySQL不执行请求的操作，如果触发器或语句本身失败，如果有after触发器，则不执行。</p>
</blockquote>
<h2 id="删除触发器"><a href="#删除触发器" class="headerlink" title="删除触发器"></a>删除触发器</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">trigger</span> get_id;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>触发器不能更新或者覆盖，因此必须先删除再创建</p>
</blockquote>
<h2 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h2><p><strong>insert 触发器</strong></p>
<ul>
<li>在insert 触发器代码内，可引用一个NEW的虚拟表，访问被插入的行</li>
<li>在before insert 触发器内，NEW中的值也可以被更新（允许更改被插入的值）</li>
<li>对于auto_increment 列，NEW 在insert 之前包含0，在insert 执行之后包含新的自动生成的值</li>
</ul>
<p><strong>delete 触发器</strong></p>
<p>在delete 触发器代码内，你可以引用一个名为OLD的虚拟表，访问被删除的行。</p>
<p>OLD中的值全部是只读的，不能更新</p>
<p>下面例子，使用OLD保存将要被删除的行到一个存档表中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create trigger 触发器名 before delete on 表1 for each row </span><br><span class="line">begin </span><br><span class="line">	insert into 表2(列,列,列)values(old.表1列名,old.表1列名,old.表1列名);</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>删除表1的数据前会把数据存到结构相同的表2中<br>使用begin end 块的好处是触发器能容纳多条sql语句</p>
<p>**UPDATE 触发器 **</p>
<p>在update触发器代码中，可以引用一个名为old虚拟表访问以前的值，引用new虚拟表访问新更新的值</p>
<p>new中的值可能被更新，old中的值全部是只读的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create trigger 触发器名 before update on 表1 for each row set new.id = upper(new.id);</span><br></pre></td></tr></table></figure>


<p>显然，每次更新一个行时，new.id 中的值（将用来更新表行的值）都用upper(new.id)替换。 也就是，如果new.id &#x3D; 110，那用update更新表1的id时，将用110这个值更新。</p>
<p><strong>触发器的进一步介绍</strong></p>
<p>触发器可以用来创建审计跟踪，使用触发器，把更改记录到另一个表非常容易</p>
<p>mysql触发器不支持call语句，这表示不能从触发器内调用存储过程，只能把存储过程代码复制到触发器内</p>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><h2 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h2><p><strong>事务（transaction）</strong>指一组SQL语句</p>
<p><strong>回滚（rollback）</strong>撤销指定SQL执行过程</p>
<p><strong>提交（commit）</strong>将为存储的SQL语句结果写入数据表</p>
<p><strong>保留点（savepoint）</strong>事务处理中设置的临时占位符（place holder） ,可以发布或者回退（与回退整个事务不同）</p>
<blockquote>
<p>事务用来管理insert, update, delete 语句，不能回退drop，select， create 操作，即使使用了也不会撤销。</p>
</blockquote>
<p>隐含事务提交：commit 或者rollback 后事务会自动关闭。</p>
<h2 id="保留点"><a href="#保留点" class="headerlink" title="保留点"></a>保留点</h2><p>简单的commit或者rollback会撤销整个事务，但是实际上可能需要回滚或者提交一部分事务，就需要在事务处理块中放置合适的保留点，回滚时回滚到某个保留点，可以使用savepoint创建保留点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">savepoint delete1;</span><br></pre></td></tr></table></figure>

<p>当需要回滚时，可以指定保留点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rollback to delete1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以尽可能多地创建保留点，因为这样就可以更灵活地控制事务。当执行commit 或者rollback 后自动释放保留点，也可以使用release savepoint 释放保留点。</p>
</blockquote>
<h2 id="更改默认提交行为"><a href="#更改默认提交行为" class="headerlink" title="更改默认提交行为"></a>更改默认提交行为</h2><p>关闭自动提交</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set autocommit = 0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该标志是针对当前连接而不是服务器</p>
</blockquote>
<h1 id="字符集和编码"><a href="#字符集和编码" class="headerlink" title="字符集和编码"></a>字符集和编码</h1><p><strong>字符集</strong> 字母和符号的集合</p>
<p><strong>编码</strong> 某个字符集内成员的内部表示</p>
<p><strong>校对</strong> 规定字符集如何比较的指令</p>
<p>查看可用的校对和字符集</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show collation;</span><br><span class="line">show variables like &#x27;%character%&#x27;;</span><br><span class="line">show variables like &#x27;%collation%&#x27;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以给单个表，单个列设置字符集和校对</p>
</blockquote>
<p>select 语句中可以指定使用不同的校对，例如可以使用区分大小写的校对</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from users order by username collate latin1_general_cs;</span><br></pre></td></tr></table></figure>

<p>使用cast() 或者convert() 可以在字符集之间转换</p>
<h1 id="数据备份"><a href="#数据备份" class="headerlink" title="数据备份"></a>数据备份</h1><h2 id="数据备份-1"><a href="#数据备份-1" class="headerlink" title="数据备份"></a>数据备份</h2><p>mysqldump</p>
<p>mysqlhotcopy 从一个数据库复制全部数据</p>
<p>back up table &#x2F; select into outfile    -&gt;  restore table </p>
<blockquote>
<p>为保证所有数据都被写到磁盘（包括索引数据），可能需要在备份前使用flush tables 语句</p>
</blockquote>
<p>命令行下具体用法如下： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -u用戶名 -p密码 -d 数据库名 表名 &gt; 脚本名;</span><br></pre></td></tr></table></figure>

<p>导出整个数据库结构和数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h localhost -uroot -p123456 database &gt; dump.sql</span><br></pre></td></tr></table></figure>

<p>导出整个数据库结构和数据[包含建库语句]</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h localhost -uroot -p123456 -B database &gt; dump.sql</span><br></pre></td></tr></table></figure>

<p>导出单个数据表结构和数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h localhost -uroot -p123456  database table &gt; dump.sql</span><br></pre></td></tr></table></figure>

<p>导出整个数据库结构（不包含数据）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h localhost -uroot -p123456  -d database &gt; dump.sql</span><br></pre></td></tr></table></figure>

<p>导出单个数据表结构（不包含数据）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h localhost -uroot -p123456  -d database table &gt; dump.sql</span><br></pre></td></tr></table></figure>

<h2 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h2><p>未登录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>uroot <span class="operator">-</span>proot <span class="operator">-</span>h127<span class="number">.0</span><span class="number">.0</span><span class="number">.1</span> <span class="operator">-</span>P3306 test<span class="operator">&lt;</span>s1.sql</span><br></pre></td></tr></table></figure>

<p>登录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source .<span class="operator">/</span>a.sql</span><br></pre></td></tr></table></figure>

<h2 id="数据维护"><a href="#数据维护" class="headerlink" title="数据维护"></a>数据维护</h2><ul>
<li>analyze table 检查表键是否正确</li>
<li>check table 针对许多问题进行检查，在myisam引擎上还针对索引进行检查 , 如果在Myisam引擎上产生的结果不正确，可能需要使用repare table 修复响应的表。</li>
<li>changed 检查自最后一次检查以来改动过的表</li>
<li>extended 执行最彻底的检查</li>
<li>fast 检查未正常关闭的表</li>
<li>medium 检查所有被删除的链接并进行键检验</li>
<li>quick 只进行快速扫描</li>
<li>optimize table  优化表，如果有大量删除操作，应该使用</li>
</ul>
<h2 id="诊断启动问题"><a href="#诊断启动问题" class="headerlink" title="诊断启动问题"></a>诊断启动问题</h2><ul>
<li>–safe-mode 装载减去某些最佳配置的服务器</li>
<li>–verbose 显示全文本消息，常与–help 联合使用</li>
</ul>
<h2 id="查看日志文件"><a href="#查看日志文件" class="headerlink" title="查看日志文件"></a>查看日志文件</h2><ul>
<li>错误日志，包含启停或任意关键位置的错误细节，日志名通常为hostname.err 位于data 目录， 可用–log-error 命令更改</li>
<li>查询日志，记录MySQL活动，在诊断问题时非常有用，日志可能会很快变得很大，所以不应该长期使用，位于data 目录，可用–log更改</li>
<li>二进制日志(bin-log)，记录更新或者可能更新过数据的所有语句，日志名通常为hostname-bin，位于data 目录，可用–log-bin 更改</li>
<li>慢查询日志， 可用–log-slow-queries 更改</li>
</ul>
<h1 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h1><p>MySQL 使用一系列默认配置预先配置的，但随着需求增加，往往需要重新调整分配内存，缓冲区等等。可以使用下面的命令查看变量以及状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show [global] variables;</span><br><span class="line">show status;</span><br></pre></td></tr></table></figure>

<p>当你遇到MySQL性能显著不良的时候，可以使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show [full] processlist</span><br></pre></td></tr></table></figure>

<p>查看活动以及他们的线程id和执行时间，可以使用kill 来终止</p>
<p>使用explain [analyze] 来解释如何执行一条SQL</p>
<p>一般来说，存储过程比一条一条执行SQL性能好</p>
<p>insert  支持一个可选的 delayed 关键字，如果使用，将把控制立即返回给调用程序，并且一旦有可能就实际执行该操作</p>
<p>在导入数据时，应该关闭自动提交，临时禁用索引，索引在导入完成后再开启</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table notes disable/enable keys;</span><br></pre></td></tr></table></figure>

<p>如果SQL存在大量OR，可以尝试使用union关键字连接结果</p>
<p>索引可能会加快查询，也可能会降低插入，更新速度</p>
<p>一般来说，尽量使用fulltext 而不是用like</p>
<h1 id="其他语法"><a href="#其他语法" class="headerlink" title="其他语法"></a>其他语法</h1><h2 id="alter"><a href="#alter" class="headerlink" title="alter"></a>alter</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">alter table &lt;table_name&gt;</span><br><span class="line">(</span><br><span class="line">	add column &lt;column_name&gt;    datatype [null|not null] [constraint],</span><br><span class="line">	change column &lt;column_name&gt; datatype [null|not null] [constraint], </span><br><span class="line">	drop column &lt;column_name&gt;</span><br><span class="line">	add index &lt;column_name&gt; </span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">ALTER table Teacher change Tid Tnum int; //修改列名</span><br></pre></td></tr></table></figure>

<h2 id="create-index"><a href="#create-index" class="headerlink" title="create index"></a>create index</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create index &lt;index_name&gt; on &lt;table_name&gt; (column [desc|asc], ...);</span><br></pre></td></tr></table></figure>

<h2 id="create-user"><a href="#create-user" class="headerlink" title="create user"></a>create user</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create user &lt;username&gt;[@host] identified [with mysql_native_password] by &lt;password&gt;; </span><br></pre></td></tr></table></figure>

<h2 id="drop"><a href="#drop" class="headerlink" title="drop"></a>drop</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop database|index|procedure|table|trigger|user|view|itemname;</span><br></pre></td></tr></table></figure>

<h2 id="insert-select"><a href="#insert-select" class="headerlink" title="insert select"></a>insert select</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into users select * from users_bak;</span><br></pre></td></tr></table></figure>

<h2 id="select-1"><a href="#select-1" class="headerlink" title="select"></a>select</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">	<span class="keyword">column</span> </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	table_name</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line"><span class="keyword">having</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span></span><br></pre></td></tr></table></figure>

<h2 id="事务-1"><a href="#事务-1" class="headerlink" title="事务"></a>事务</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start transaction;</span><br></pre></td></tr></table></figure>

<h2 id="排序-1"><a href="#排序-1" class="headerlink" title="排序"></a>排序</h2><p>字符串以字典顺序排序，从左向右一次比较每一个字符，这将导致‘10‘位于’2‘之前，数值才能正确排序。</p>
<h1 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop procedure &lt;procedure_name&gt; [if exists]</span><br></pre></td></tr></table></figure>


<h1 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> 语句耗时，可能因为等待而降低<span class="keyword">select</span>性能，所以使用下面的语句降低有限级</span><br><span class="line"><span class="keyword">INSERT</span> LOW_PRIORITY <span class="keyword">INTO</span></span><br><span class="line"><span class="comment">--降低insert的有限级，同样适用于update,delete。</span></span><br></pre></td></tr></table></figure>

<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><p>更新可以使用子查询，即将查到的值更新到列。<br>update ignore 可以忽略错误</p>
<p>更新表不能包含该表的子查询例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update user set sex = 1 where id in (select id from user where age &gt; 8)</span><br></pre></td></tr></table></figure>

<p>上面的SQL会报错，应该更改为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update user left inner join (select id from user where age &gt; 8) set sex = 1;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面的SQL只是示例</p>
</blockquote>
<h2 id="删除-1"><a href="#删除-1" class="headerlink" title="删除"></a>删除</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">truncate [table] users;</span><br><span class="line">delete from </span><br></pre></td></tr></table></figure>


<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p>外键不能跨引擎，例如myisam不能添加innodb表的主键为外键</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rename <span class="keyword">table</span> notes <span class="keyword">to</span> note;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> notes rename <span class="keyword">to</span> note;</span><br></pre></td></tr></table></figure>

<h1 id="Mysql添加自增列"><a href="#Mysql添加自增列" class="headerlink" title="Mysql添加自增列"></a>Mysql添加自增列</h1><p>两句查完：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="variable">@rownum</span><span class="operator">=</span><span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> (<span class="variable">@rownum</span>:<span class="operator">=</span><span class="variable">@rownum</span><span class="operator">+</span><span class="number">1</span>),colname <span class="keyword">from</span> [tablename <span class="keyword">or</span> (subquery) a];</span><br></pre></td></tr></table></figure>

<p>一句查完：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select @rownum:=@rownum+1,colnum from (select @rownum:=0) a,[tablename or (subquery) b];</span><br></pre></td></tr></table></figure>


<blockquote>
<p>多条SQL要用<code>;</code>分割，单条SQL末尾的分号非必须，推荐加上分号，如果使用命令行，则必须要有结尾符。</p>
</blockquote>
<blockquote>
<p>SQL 语句不区分大小写。最佳的方式是按照大小写惯例，且使用时保持一致。</p>
</blockquote>
<blockquote>
<p>SQL可以分成多行，用更直观的格式表达</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">desc</span> <span class="operator">/</span> <span class="keyword">describe</span> <span class="operator">&lt;</span><span class="keyword">table</span><span class="operator">&gt;</span>;</span><br></pre></td></tr></table></figure>

<h1 id="函数-1"><a href="#函数-1" class="headerlink" title="函数"></a>函数</h1><h2 id="COALLESCE"><a href="#COALLESCE" class="headerlink" title="COALLESCE"></a>COALLESCE</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COALESCE(expression, value1, value2, valuen)</span><br></pre></td></tr></table></figure>

<p>返回按顺序取第一个不为NULL的值，都为NULL则返回NULL, 因为不判断空字符串，所以如果有空字符串则需要先处理，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COALESCE(NULLIF(text1, &#x27;&#x27;), NULLIF(text2, &#x27;&#x27;))</span><br></pre></td></tr></table></figure>
<p>其他替代</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--MYSQL: </span><br><span class="line">  IFNULL(expression,value) </span><br><span class="line">--MSSQLServer: </span><br><span class="line">  ISNULL(expression,value) </span><br><span class="line">--Oracle: </span><br><span class="line">  NVL(expression,value)</span><br></pre></td></tr></table></figure>

<h2 id="格式化时间日期"><a href="#格式化时间日期" class="headerlink" title="格式化时间日期"></a>格式化时间日期</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/shuilangyizu/p/8036620.html">https://www.cnblogs.com/shuilangyizu/p/8036620.html</a></p>
<h2 id="IF"><a href="#IF" class="headerlink" title="IF"></a>IF</h2><p>Mysql的if既可以作为表达式用，也可在存储过程中作为流程控制语句使用<br>IF表达式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IF(expr1,expr2,expr3)</span><br></pre></td></tr></table></figure>



<p>如果 expr1 是TRUE (expr1 &lt;&gt; 0 and expr1 &lt;&gt; NULL)，则 IF()的返回值为expr2; 否则返回值则为 expr3。IF() 的返回值为数字值或字符串值，具体情况视其所在语境而定。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select *,if(sva=1,&quot;男&quot;,&quot;女&quot;) as ssva from taname where sva != &quot;&quot;</span><br></pre></td></tr></table></figure>



<p>作为表达式的if也可以用CASE when来实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select CASE sva WHEN 1 THEN &#x27;男&#x27; ELSE &#x27;女&#x27; END as ssva from taname where sva != &#x27;&#x27;</span><br></pre></td></tr></table></figure>



<p>在第一个方案的返回结果中， value&#x3D;compare-value。而第二个方案的返回结果是第一种情况的真实结果。如果没有匹配的结果值，则返回结果为ELSE后的结果，如果没有ELSE 部分，则返回值为 NULL。</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT CASE 1 WHEN 1 THEN &#x27;one&#x27;</span><br><span class="line">              WHEN 2 THEN &#x27;two&#x27;</span><br><span class="line">              ELSE &#x27;more&#x27; END</span><br><span class="line">              as testCol</span><br></pre></td></tr></table></figure>

<p>将输出one</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IFNULL(expr1,expr2)</span><br></pre></td></tr></table></figure>


<p>假如expr1 不为 NULL，则 IFNULL() 的返回值为 expr1; 否则其返回值为 expr2。IFNULL()的返回值是数字或是字符串，具体情况取决于其所使用的语境。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT IFNULL(1,0);</span><br><span class="line">        -&gt; 1</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT IFNULL(NULL,10);</span><br><span class="line">        -&gt; 10</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT IFNULL(1/0,10);</span><br><span class="line">        -&gt; 10</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT IFNULL(1/0,&#x27;yes&#x27;);</span><br><span class="line">        -&gt; &#x27;yes&#x27;</span><br></pre></td></tr></table></figure>


<p>IFNULL(expr1,expr2) 的默认结果值为两个表达式中更加“通用”的一个，顺序为STRING、 REAL或 INTEGER。</p>
<p>IF ELSE 做为流程控制语句使用<br>if实现条件判断，满足不同条件执行不同的操作，这个我们只要学编程的都知道if的作用了，下面我们来看看mysql 存储过程中的if是如何使用的吧。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IF search_condition <span class="keyword">THEN</span></span><br><span class="line">    statement_list</span><br><span class="line">[ELSEIF search_condition <span class="keyword">THEN</span>]</span><br><span class="line">    statement_list ...</span><br><span class="line">[<span class="keyword">ELSE</span></span><br><span class="line">    statement_list]</span><br><span class="line"><span class="keyword">END</span> IF</span><br></pre></td></tr></table></figure>

<p>当IF中条件search_condition成立时，执行THEN后的statement_list语句，否则判断ELSEIF中的条件，成立则执行其后的statement_list语句，否则继续判断其他分支。当所有分支的条件均不成立时，执行ELSE分支。search_condition是一个条件表达式，可以由“&#x3D;、&lt;、&lt;&#x3D;、&gt;、&gt;&#x3D;、!&#x3D;”等条件运算符组成，并且可以使用AND、OR、NOT对多个表达式进行组合。</p>
<p>例如，建立一个存储过程，该存储过程通过学生学号（student_no）和课程编号（course_no）查询其成绩（grade），返回成绩和成绩的等级，成绩大于90分的为A级，小于90分大于等于80分的为B级，小于80分大于等于70分的为C级，依次到E级。那么，创建存储过程的代码如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> dbname.proc_getGrade</span><br><span class="line">(stu_no <span class="type">varchar</span>(<span class="number">20</span>),cour_no <span class="type">varchar</span>(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">declare</span> stu_grade <span class="type">float</span>;</span><br><span class="line"><span class="keyword">select</span> grade <span class="keyword">into</span> stu_grade <span class="keyword">from</span> grade <span class="keyword">where</span> student_no<span class="operator">=</span>stu_no <span class="keyword">and</span> course_no<span class="operator">=</span>cour_no;</span><br><span class="line">if stu_grade<span class="operator">&gt;=</span><span class="number">90</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">select</span> stu_grade,<span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">elseif stu_grade<span class="operator">&lt;</span><span class="number">90</span> <span class="keyword">and</span> stu_grade<span class="operator">&gt;=</span><span class="number">80</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">select</span> stu_grade,<span class="string">&#x27;B&#x27;</span>;</span><br><span class="line">elseif stu_grade<span class="operator">&lt;</span><span class="number">80</span> <span class="keyword">and</span> stu_grade<span class="operator">&gt;=</span><span class="number">70</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">select</span> stu_grade,<span class="string">&#x27;C&#x27;</span>;</span><br><span class="line">elseif stu_grade70 <span class="keyword">and</span> stu_grade<span class="operator">&gt;=</span><span class="number">60</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">select</span> stu_grade,<span class="string">&#x27;D&#x27;</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">select</span> stu_grade,<span class="string">&#x27;E&#x27;</span>;</span><br><span class="line"><span class="keyword">end</span> if;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>


<p>注意：IF作为一条语句，在END IF后需要加上分号“;”以表示语句结束，其他语句如CASE、LOOP等也是相同的。</p>
<blockquote>
<p>help show 查看允许的show语句</p>
</blockquote>
<h1 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tee /home/cheng/log.sql</span><br></pre></td></tr></table></figure>

<p>将下面的操作都写入改日志</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> testdb.<span class="operator">*</span> <span class="keyword">to</span> ‘test_user’@’localhost’ identified <span class="keyword">by</span> “jack” <span class="keyword">with</span> <span class="keyword">grant</span> option;</span><br></pre></td></tr></table></figure>

<p>WITH GRANT OPTION 这个选项表示该用户可以将自己拥有的权限授权给别人。注意：经常有人在创建操作用户的时候不指定WITH GRANT OPTION选项导致后来该用户不能使用GRANT命令创建用户或者给其它用户授权。<br>如果不想这个用户有这个grant的权限，可以不加这句</p>
<h2 id="mysql的SQL长度限制"><a href="#mysql的SQL长度限制" class="headerlink" title="mysql的SQL长度限制"></a>mysql的SQL长度限制</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_allowed_packet = 6M</span><br></pre></td></tr></table></figure>

<p>把上面这个配置改大就行了</p>
<h2 id="监听SQL"><a href="#监听SQL" class="headerlink" title="监听SQL"></a>监听SQL</h2><p>登录mysql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set global general_log_file=&#x27;/tmp/general.log&#x27;;</span><br><span class="line">set global general_log=&#x27;on&#x27;;</span><br></pre></td></tr></table></figure>
<p>之后执行命令都会记录进LOG</p>
<h2 id="排序-2"><a href="#排序-2" class="headerlink" title="排序"></a>排序</h2><p>MySQL中的排序ORDER BY 除了可以用ASC和DESC，还可以自定义字符串&#x2F;数字来实现排序。</p>
<p>格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM table ORDER BY FIELD(status,1,2,0);</span><br></pre></td></tr></table></figure>

<p>这样子写的话，返回的结果集是按照字段status的1、2、0进行排序的，当然，也可以对字符串进行排序。</p>
<p>原理如下：</p>
<p>FIELD()函数是将参数1的字段对后续参数进行比较，并返回1、2、3等等，如果遇到null或者没有在结果集上存在的数据，则返回0，然后根据升序进行排序。</p>
<h1 id="json字段"><a href="#json字段" class="headerlink" title="json字段"></a>json字段</h1><p>自<em>MySQL5.7.8</em>版本以来，MySQL支持原生JSON数据类型。允许使用原生JSON数据类型比以前MySQL版本中所使用JSON文本格式更能有效地存储JSON文档。</p>
<p>MySQL以内部格式存储JSON文档，允许对文档元素的快速读取访问。JSON二进制格式的结构是允许服务器通过键或数组索引直接搜索JSON文档中的值，这非常快。</p>
<p>JSON文档的存储大约与存储<code>LONGBLOB</code>或<code>LONGTEXT</code>数据量相同。</p>
<p>要定义数据类型为JSON的列，请使用以下语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `json_test` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `j` json <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>json列不能有默认值，而且不能直接编入索引，可以在包含从json列中提取的生成列上创建索引，当从JSON列查询数据时，MySQL优化器将在匹配JSON表达式的虚拟列上查找兼容的索引。</p>
</blockquote>
<p>如下json数据，存储为两条记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> json_test <span class="keyword">values</span>(<span class="number">2</span>, <span class="string">&#x27;&#123;&quot;name&quot;:&quot;test&quot;,&quot;age&quot;: 14&#125;&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> json_test <span class="keyword">values</span>(<span class="number">2</span>, <span class="string">&#x27;&#123;&quot;name&quot;:&quot;test1&quot;,&quot;age&quot;: 12&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>查询，使用列路径运算符(<code>-&gt;</code>)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, j<span class="operator">-</span><span class="operator">&gt;</span><span class="string">&#x27;$.name&#x27;</span> <span class="keyword">as</span> name <span class="keyword">from</span> json_test;</span><br></pre></td></tr></table></figure>

<p>查询结果如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+----+------------+</span><br><span class="line">| id | name       |</span><br><span class="line">+----+------------+</span><br><span class="line">|  1 | &quot;chengyao&quot; |</span><br><span class="line">|  2 | &quot;test&quot;     |</span><br><span class="line">+----+------------+</span><br></pre></td></tr></table></figure>

<p>name列值中有引号，怎么去掉，可以使用内联路径运算符( <code>-&gt;&gt;</code>)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, j<span class="operator">-</span><span class="operator">&gt;&gt;</span><span class="string">&#x27;$.name&#x27;</span> <span class="keyword">as</span> name <span class="keyword">from</span> json_test;</span><br></pre></td></tr></table></figure>

<p>查询结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | chengyao |</span><br><span class="line">|  2 | test     |</span><br><span class="line">+----+----------+</span><br></pre></td></tr></table></figure>

<p>json函数： <a target="_blank" rel="noopener" href="https://blog.csdn.net/dragonpeng2008/article/details/89479698">(53条消息) MySQL常用Json函数_dragonpeng2008的博客-CSDN博客</a></p>
<h1 id="生成列"><a href="#生成列" class="headerlink" title="生成列"></a>生成列</h1><p><em>MySQL 5.7</em>引入了一个名为<em>生成列</em>的新功能。它之所以叫作<em>生成列</em>，因为此列中的数据是基于预定义的表达式或从其他列计算的。</p>
<p>例如，假设有以下结构的一个<code>contacts</code>表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> contacts (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    first_name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    last_name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>要获取联系人的全名，请使用<code>CONCAT()</code>函数，如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    id, CONCAT(first_name, <span class="string">&#x27; &#x27;</span>, last_name), email</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    contacts;</span><br></pre></td></tr></table></figure>

<p>这不是最优的查询。</p>
<p>通过使用MySQL生成的列，可以重新创建<code>contacts</code>表，如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> contacts;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> contacts (</span><br><span class="line">    id <span class="type">INT</span> AUTO_INCREMENT <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    first_name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    last_name <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    fullname <span class="type">varchar</span>(<span class="number">101</span>) GENERATED ALWAYS <span class="keyword">AS</span> (CONCAT(first_name,<span class="string">&#x27; &#x27;</span>,last_name)),</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><code>GENERATED ALWAYS as(expression)</code>是创建生成列的语法。要测试“全名”列，请在<code>contacts</code>表中插入一行。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> contacts(first_name,last_name, email)</span><br><span class="line"><span class="keyword">VALUES</span>(<span class="string">&#x27;john&#x27;</span>,<span class="string">&#x27;doe&#x27;</span>,<span class="string">&#x27;john.doe@yiibai.com&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>现在，可以从<code>contacts</code>表中查询数据。</p>
<p>当从<code>contacts</code>表中查询数据时，<code>fullname</code>列中的值将立即计算。</p>
<p>MySQL提供了两种类型的生成列：存储和虚拟。每次读取数据时，虚拟列都将在运行中计算，而存储的列在数据更新时被物理计算和存储。</p>
<p>基于此定义，上述示例中的<code>fullname</code>列是虚拟列。</p>
<h2 id="MySQL生成列的语法"><a href="#MySQL生成列的语法" class="headerlink" title="MySQL生成列的语法"></a>MySQL生成列的语法</h2><p>定义生成列的语法如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">column_name data_type [GENERATED ALWAYS] <span class="keyword">AS</span> (expression)</span><br><span class="line">   [VIRTUAL <span class="operator">|</span> STORED] [<span class="keyword">UNIQUE</span> [KEY]]</span><br></pre></td></tr></table></figure>

<p>首先，指定列名及其数据类型。</p>
<p>接下来，添加<code>GENERATED ALWAYS</code>子句以指示列是生成的列。</p>
<p>然后，通过使用相应的选项来指示生成列的类型：<code>VIRTUAL</code>或<code>STORED</code>。 默认情况下，如果未明确指定生成列的类型，MySQL将使用<code>VIRTUAL</code>。</p>
<p>之后，在<code>AS</code>关键字后面的大括号内指定表达式。 该表达式可以包含文字，内置函数，无参数，操作符或对同一表中任何列的引用。 如果你使用一个函数，它必须是标量和确定性的。</p>
<p>最后，如果生成的列被存储，可以为它定义一个唯一约束。</p>
<h2 id="MySQL存储列示例"><a href="#MySQL存储列示例" class="headerlink" title="MySQL存储列示例"></a>MySQL存储列示例</h2><p>我们来看一下<code>products</code>表。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">desc</span> products;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> Field              <span class="operator">|</span> Type          <span class="operator">|</span> <span class="keyword">Null</span> <span class="operator">|</span> Key <span class="operator">|</span> <span class="keyword">Default</span> <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="operator">|</span> productCode        <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">15</span>)   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> PRI <span class="operator">|</span>         <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> productName        <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">70</span>)   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> productLine        <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">50</span>)   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> MUL <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> productScale       <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">10</span>)   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> productVendor      <span class="operator">|</span> <span class="type">varchar</span>(<span class="number">50</span>)   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> productDescription <span class="operator">|</span> text          <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> quantityInStock    <span class="operator">|</span> <span class="type">smallint</span>(<span class="number">6</span>)   <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> buyPrice           <span class="operator">|</span> <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MSRP               <span class="operator">|</span> <span class="type">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span>     <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------------+------+-----+---------+-------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span></span><br></pre></td></tr></table></figure>

<p>使用<code>quantityInStock</code>和<code>buyPrice</code>列的数据，通过以下表达式计算每个<code>SKU</code>的股票值：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">quantityInStock <span class="operator">*</span> buyPrice</span><br></pre></td></tr></table></figure>

<p>但是，可以使用以下<a target="_blank" rel="noopener" href="http://www.yiibai.com/mysql/add-column.html" title="ALTER TABLE ... ADD COLUMN">ALTER TABLE … ADD COLUMN</a>语句将名为<code>stock_value</code>的存储的生成列添加到<code>products</code>表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> products</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">COLUMN</span> stockValue <span class="keyword">DOUBLE</span> </span><br><span class="line">GENERATED ALWAYS <span class="keyword">AS</span> (buyprice<span class="operator">*</span>quantityinstock) STORED;</span><br></pre></td></tr></table></figure>

<p>通常，<code>ALTER TABLE</code>语句需要完整的表重建，因此，如果更改大表是耗时的。 但是，虚拟列并非如此。</p>
<p>现在，我们可以直接从<code>products</code>表中查询库存值。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    productName, ROUND(stockValue, <span class="number">2</span>) <span class="keyword">AS</span> stock_value</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    products;</span><br></pre></td></tr></table></figure>

<p>执行上面查询语句，得到以下结果 -</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+---------------------------------------------+-------------+</span><br><span class="line">| productName                                 | stock_value |</span><br><span class="line">+---------------------------------------------+-------------+</span><br><span class="line">| 1969 Harley Davidson Ultimate Chopper       |   387209.73 |</span><br><span class="line">| 1952 Alpine Renault 1300                    |   720126.90 |</span><br><span class="line">| 1996 Moto Guzzi 1100i                       |   457058.75 |</span><br><span class="line">| 2003 Harley-Davidson Eagle Drag Bike        |   508073.64 |</span><br><span class="line">| 1972 Alfa Romeo GTA                         |   278631.36 |</span><br><span class="line">| 1962 LanciaA Delta 16V                      |   702325.22 |</span><br><span class="line">| 1968 Ford Mustang                           |     6483.12 |</span><br><span class="line">|************** 省略了一大波数据 ****************************|</span><br><span class="line">| The Queen Mary                              |   272869.44 |</span><br><span class="line">| American Airlines: MD-11S                   |   319901.40 |</span><br><span class="line">| Boeing X-32A JSF                            |   159163.89 |</span><br><span class="line">| Pont Yacht                                  |    13786.20 |</span><br><span class="line">+---------------------------------------------+-------------+</span><br><span class="line">110 rows in set</span><br></pre></td></tr></table></figure>

<p>参考： <a target="_blank" rel="noopener" href="https://www.yiibai.com/mysql/generated-columns.html">MySQL生成列 - MySQL教程 (yiibai.com)</a></p>
<h1 id="常见错误处理"><a href="#常见错误处理" class="headerlink" title="常见错误处理"></a>常见错误处理</h1><h2 id="Operation-CREATE-USER-failed-for-XXX"><a href="#Operation-CREATE-USER-failed-for-XXX" class="headerlink" title="Operation CREATE USER failed for XXX"></a>Operation CREATE USER failed for XXX</h2><p>原因：可能是执行了如下操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span>  <span class="keyword">from</span>  mysql.user  <span class="keyword">where</span> <span class="keyword">user</span> <span class="operator">=</span><span class="string">&#x27;user_1&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>需要再执行下面命令</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> user1;</span><br></pre></td></tr></table></figure>

<h2 id="ERROR-1269-HY000-Can’t-revoke-all-privileges-for-one-or-more-of-the-requested-users"><a href="#ERROR-1269-HY000-Can’t-revoke-all-privileges-for-one-or-more-of-the-requested-users" class="headerlink" title="ERROR 1269 (HY000): Can’t revoke all privileges for one or more of the requested users"></a>ERROR 1269 (HY000): Can’t revoke all privileges for one or more of the requested users</h2><p>需要加上host，例如</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">FROM</span> <span class="string">&#x27;testuser&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="字符校对规则问题"><a href="#字符校对规则问题" class="headerlink" title="字符校对规则问题"></a>字符校对规则问题</h2><p>查询视图时报错：java.sql.SQLException: Illegal mix of collations (utf8mb4_general_ci,IMPLICIT) and (utf8mb4_0900_ai_ci,IMPLICIT) for operation ‘&#x3D;’；</p>
<p>本地环境:<code>mysql8.0.13</code></p>
<p>异常提示排序规则编码混乱，mysql8.0.1之后的默认COLLATE为utf8mb4_0900_ai_ci；</p>
<p>检查视图中所包含的表发现其中一个建表时 没有设置编码，并且其他的表设置的是 CHARSET&#x3D;utf8mb4 COLLATE&#x3D;utf8mb4_general_ci；因此导致混乱；</p>
<p>查看当前数据库的默认编码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show variables <span class="built_in">where</span> Variable_name like <span class="string">&#x27;collation%&#x27;</span>;</span></span><br></pre></td></tr></table></figure>


<p>查看各表编码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show create table ‘table_name’;</span></span><br></pre></td></tr></table></figure>
<p>解决方案给没有设置编码的表重新设置一下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">alter table table_name default character <span class="built_in">set</span> utf8mb4 collate=utf8mb4_general_ci;</span></span><br></pre></td></tr></table></figure>


<p>这样设置只针对表的，但是表中字段未修改：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">ALTER TABLE table_name convert to CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;</span></span><br></pre></td></tr></table></figure>

<p>修改完成以后，重新创建视图！！！！</p>
<h2 id="排序内存溢出问题"><a href="#排序内存溢出问题" class="headerlink" title="排序内存溢出问题"></a>排序内存溢出问题</h2><p>报错：<br><code>SQLSTATE[HY001]: Memory allocation error: 1038 Out of sort memory, consider increasing sort buffer size</code></p>
<p>找到mysql配置文件（我的是<code>/etc/mysql/mysql.conf.d/mysqld.cnf</code>）, 添加一行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sort_buffer_size        = 16M</span><br></pre></td></tr></table></figure>
<p>重启数据库，报错继续加大</p>
<h2 id="数据类型相关"><a href="#数据类型相关" class="headerlink" title="数据类型相关"></a>数据类型相关</h2><p>记录datetime到毫秒<br>5.6 之后可以将字段类型设置为datetime(3), 其中的数字表示精度，三位精确到毫秒</p>
<h2 id="Incorrect-key-file-for-notes"><a href="#Incorrect-key-file-for-notes" class="headerlink" title="Incorrect key file for notes"></a>Incorrect key file for notes</h2><p>解决方案（目前使用myisam引擎）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">optimize <span class="keyword">table</span> notes;</span><br></pre></td></tr></table></figure>
<p>如果不行就google一下</p>
<h2 id="不用密码登录"><a href="#不用密码登录" class="headerlink" title="不用密码登录"></a>不用密码登录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br></pre></td></tr></table></figure>

<p>在[mysqld]段后加一行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skip-grant-tables</span><br></pre></td></tr></table></figure>

<p>或者用这条命令运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/mysqld --skip-grant-tables</span><br></pre></td></tr></table></figure>

<p>重启mysql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysql restart</span><br><span class="line">service mysql restart</span><br></pre></td></tr></table></figure>

<h2 id="修改validate-password-policy参数的值"><a href="#修改validate-password-policy参数的值" class="headerlink" title="修改validate_password_policy参数的值"></a>修改validate_password_policy参数的值</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set global validate_password_policy=0;</span><br><span class="line">#validate_password_length(密码长度)参数默认为8，修改为需要长度</span><br><span class="line">set global validate_password_length=1;</span><br></pre></td></tr></table></figure>

<h2 id="mysqld命令"><a href="#mysqld命令" class="headerlink" title="mysqld命令"></a>mysqld命令</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/shymen/p/8850655.html">https://www.cnblogs.com/shymen/p/8850655.html</a></p>
<h2 id="utf8-unicode-ci与utf8-general-ci的区别"><a href="#utf8-unicode-ci与utf8-general-ci的区别" class="headerlink" title="utf8_unicode_ci与utf8_general_ci的区别"></a>utf8_unicode_ci与utf8_general_ci的区别</h2><p>当前，utf8_unicode_ci校对规则仅部分支持Unicode校对规则算法。一些字符还是不能支持。并且，不能完全支持组合的记号。这主要影响越南和俄罗斯的一些少数民族语言，如：Udmurt 、Tatar、Bashkir和Mari。</p>
<p>utf8_unicode_ci的最主要的特色是支持扩展，即当把一个字母看作与其它字母组合相等时。例如，在德语和一些其它语言中‘ß’等于‘ss’。</p>
<p>utf8_general_ci是一个遗留的 校对规则，不支持扩展。它仅能够在字符之间进行逐个比较。这意味着utf8_general_ci校对规则进行的比较速度很快，但是与使用utf8_unicode_ci的校对规则相比，比较正确性较差）。</p>
<p>例如，使用utf8_general_ci和utf8_unicode_ci两种 校对规则下面的比较相等：</p>
<p>Ä &#x3D; A</p>
<p>Ö &#x3D; O</p>
<p>Ü &#x3D; U</p>
<p>两种校对规则之间的区别是，对于utf8_general_ci下面的等式成立：</p>
<p>ß &#x3D; s</p>
<p>但是，对于utf8_unicode_ci下面等式成立：</p>
<p>ß &#x3D; ss</p>
<p>对于一种语言仅当使用utf8_unicode_ci排序做的不好时，才执行与具体语言相关的utf8字符集 校对规则。例如，对于德语和法语，utf8_unicode_ci工作的很好，因此不再需要为这两种语言创建特殊的utf8校对规则。</p>
<p>utf8_general_ci也适用与德语和法语，除了‘ß’等于‘s’，而不是‘ss’之外。如果你的应用能够接受这些，那么应该使用utf8_general_ci，因为它速度快。否则，使用utf8_unicode_ci，因为它比较准确。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-04T15:52:29.000Z" title="2021/7/4 下午11:52:29">2021-07-04</time>发表</span><span class="level-item"><time dateTime="2022-08-28T02:23:10.673Z" title="2022/8/28 上午10:23:10">2022-08-28</time>更新</span><span class="level-item">7 分钟读完 (大约1119个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/04/%E5%85%B3%E4%BA%8E%E7%89%88%E6%9D%83%E5%92%8C%E5%BC%80%E6%BA%90%E5%8D%8F%E8%AE%AE/">关于版权和开源协议</a></h1><div class="content"><p>相信大家都有在一些软件或者网页的某个角落里看到这样一个词：<code>Copyright</code> 或者一个<code>©</code>的符号，那么这个<code>Copyright</code> 是什么意思呢? 直译过来就是<code>版权</code>,<code>受版权保护的</code>, 它指的是保留一切权利，即软件的一切权力归作者所有。其中包括开源软件，免费软件，共享软件，传统商业软件。 <code>Copyright</code> 是商业软件中最常用的。这种软件用户只有使用权，可以通过出售，出售源代码等方式来盈利。<br>理查德﹡斯托曼（Richard Matthew Stallman, RMS…）声称: &quot;软件的自由，关系到人类的自由&quot; , 在1983年9月创建了GNU项目，1984年发表了《GNU宣言》，抨击了封闭源代码的行为，同时<code>Copyleft</code> 一词也诞生了。</p>
<p>&gt; （转）（1）Linux仅仅是一个内核，由林纳斯创始。内核是什么？内核建立了计算机软件与硬件之间通讯的平台，内核提供系统服务，比如文件管理、虚拟内存、设备I&#x2F;O等。由此可见，内核解决的问题是硬件管理，并不包含外围的应用程序，所以对于大多数人来说无法正常使用。（2）GNU是一个技术组织，发起人是 Richard Stallman。GNU的哲学就是：软件源码看成人类共同拥有的知识财富，应该公开地自由交换、修改。在Richard Stallman精神感召下，林纳斯带着Linux加入了GNU组织，Linux本身遵循GPL版权可协议，同时又把GNU的很多软件集成了进去，从而形成了GNU&#x2F;Linux。GNU&#x2F;Linux的意思是：外围程序&#x2F;操作系统内核。补充：关于GNU和Linux的更多介绍请参考：什么是Linux、GNU&#x2F;Linux、GNU、GPL？ 参考： <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/39160602/answer/1690683979">https://www.zhihu.com/question/39160602/answer/1690683979</a></p>
<p><code>Copyleft</code> 现在被译作<code>公共版权</code>,<code>非盈利版权</code>， 它反对一切权力归作者所有，保护知识共享，权利共享，用户和作者拥有除了版权以外的完全同等的权力，包括复制和再发布，唯一不许可的就是不允许任何人将软件据为私有。<code>Copyleft</code> 是为了反对商业软件而生的，但是也并不是放弃了版权，它也被译作“著佐权”， 即通过许可证的形式，补足，辅佐著作权不足的版权授权。</p>
<p>基于<code>Copyleft</code>思想的<code>GPL</code>协议是使用最广泛的许可证之一。这个许可证在开放源代码的前提下要求用户修改后的软件要开源，并且如果用户将<code>GPL</code>许可证的软件添加到专有软件，那么新组合的软件也应当全部适用于<code>GPL</code>协议，，也就是说，组合里的软件必须要开源，所以<code>GPL</code>协议被称为具有&quot;传染性&quot;的协议。</p>
<p>&gt; （转）开源就是为了包容更多东西，圈子越大生态越大，基于生态就可以做商业化。</p>
<p>那么有人会问：如果我使用了开源软件，但是没有遵守开源协议，会有什么后果呢？ 举个例子吧， 数字天堂有一款软件Hbuilder, 柚子（北京）移动信息技术有限公司的软件APICloud复制并修改了Hbuilder中的3个插件，而这三个插件全部采用了GPL协议，但是APICloud却没有全部开源，因此柚子公司被数字天堂索赔184万元。</p>
<p>所以大家在使用开源软件时候一定要确认软件的许可协议，比如Apache2.0, MIT，BSD等等，还需要了解使用这些协议的开源软件要注意什么，比如版权信息是否需要加在每个文件中，修改后能否闭源，至于这些内容的话，网上有一张图大家可以百度下&quot;一张图看懂开源协议&quot; 这样的关键字，就可以看到针对6种开源协议需要注意的内容。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-02T03:24:40.000Z" title="2021/7/2 上午11:24:40">2021-07-02</time>发表</span><span class="level-item"><time dateTime="2022-08-28T02:23:10.673Z" title="2022/8/28 上午10:23:10">2022-08-28</time>更新</span><span class="level-item">3 分钟读完 (大约456个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/07/02/%E6%9F%A5%E7%9C%8Bmysql%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%B9%E9%87%8F%E5%A4%A7%E5%B0%8F/">查看mysql数据库容量大小</a></h1><div class="content"><h1 id="第一种情况"><a href="#第一种情况" class="headerlink" title="第一种情况"></a>第一种情况</h1><h2 id="查询所有数据库的总大小，方法如下："><a href="#查询所有数据库的总大小，方法如下：" class="headerlink" title="查询所有数据库的总大小，方法如下："></a>查询所有数据库的总大小，方法如下：</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&amp;</span>gt; use information_schema;</span><br><span class="line">mysql<span class="operator">&amp;</span>gt; <span class="keyword">select</span> concat(round(<span class="built_in">sum</span>(DATA_LENGTH<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>),<span class="number">2</span>),<span class="string">&#x27;MB&#x27;</span>) <span class="keyword">as</span> data <span class="keyword">from</span> TABLES;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> data      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3052.76</span>MB <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>
<h2 id="统计一下所有库数据量"><a href="#统计一下所有库数据量" class="headerlink" title="统计一下所有库数据量"></a>统计一下所有库数据量</h2><p>每张表数据量<code>=AVG_ROW_LENGTH*TABLE_ROWS+INDEX_LENGTH</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(AVG_ROW_LENGTH<span class="operator">*</span>TABLE_ROWS<span class="operator">+</span>INDEX_LENGTH)<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span> <span class="keyword">AS</span> total_mb <span class="keyword">FROM</span> information_schema.TABLES </span><br></pre></td></tr></table></figure>
<h2 id="统计每个库大小："><a href="#统计每个库大小：" class="headerlink" title="统计每个库大小："></a>统计每个库大小：</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT table_schema,SUM(AVG_ROW_LENGTH*TABLE_ROWS+INDEX_LENGTH)/1024/1024 AS total_mb FROM information_schema.TABLES group by table_schema;  </span><br></pre></td></tr></table></figure>

<h1 id="第二种情况"><a href="#第二种情况" class="headerlink" title="第二种情况"></a>第二种情况</h1><p>&gt;查看指定数据库的大小，比如说：数据库test，方法如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&amp;</span>gt; use information_schema;</span><br><span class="line">mysql<span class="operator">&amp;</span>gt; <span class="keyword">select</span> concat(round(<span class="built_in">sum</span>(DATA_LENGTH<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>),<span class="number">2</span>),<span class="string">&#x27;MB&#x27;</span>) <span class="keyword">as</span> data <span class="keyword">from</span> TABLES <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="string">&#x27;test&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> data     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">142.84</span>MB <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h2 id="查看所有数据库各容量大小"><a href="#查看所有数据库各容量大小" class="headerlink" title="查看所有数据库各容量大小"></a>查看所有数据库各容量大小</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">select</span><br><span class="line">table_schema as &#x27;数据库&#x27;,</span><br><span class="line">sum(table_rows) as &#x27;记录数&#x27;,</span><br><span class="line">sum(truncate(data_length/1024/1024, 2)) as &#x27;数据容量(MB)&#x27;,</span><br><span class="line">sum(truncate(index_length/1024/1024, 2)) as &#x27;索引容量(MB)&#x27;</span><br><span class="line">from information_schema.tables</span><br><span class="line">group by table_schema</span><br><span class="line">order by sum(data_length) desc, sum(index_length) desc;</span><br></pre></td></tr></table></figure>
<h2 id="查看所有数据库各表容量大小"><a href="#查看所有数据库各表容量大小" class="headerlink" title="查看所有数据库各表容量大小"></a>查看所有数据库各表容量大小</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">select</span><br><span class="line">table_schema as &#x27;数据库&#x27;,</span><br><span class="line">table_name as &#x27;表名&#x27;,</span><br><span class="line">table_rows as &#x27;记录数&#x27;,</span><br><span class="line">truncate(data_length/1024/1024, 2) as &#x27;数据容量(MB)&#x27;,</span><br><span class="line">truncate(index_length/1024/1024, 2) as &#x27;索引容量(MB)&#x27;</span><br><span class="line">from information_schema.tables</span><br><span class="line">order by data_length desc, index_length desc;</span><br></pre></td></tr></table></figure>
<h2 id="查看指定数据库容量大小"><a href="#查看指定数据库容量大小" class="headerlink" title="查看指定数据库容量大小"></a>查看指定数据库容量大小</h2><p>例：查看mysql库容量大小</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">select</span><br><span class="line">table_schema as &#x27;数据库&#x27;,</span><br><span class="line">sum(table_rows) as &#x27;记录数&#x27;,</span><br><span class="line">sum(truncate(data_length/1024/1024, 2)) as &#x27;数据容量(MB)&#x27;,</span><br><span class="line">sum(truncate(index_length/1024/1024, 2)) as &#x27;索引容量(MB)&#x27;</span><br><span class="line">from information_schema.tables</span><br><span class="line">where table_schema=&#x27;mysql&#x27;;　</span><br></pre></td></tr></table></figure>
<h2 id="查看指定数据库各表容量大小"><a href="#查看指定数据库各表容量大小" class="headerlink" title="查看指定数据库各表容量大小"></a>查看指定数据库各表容量大小</h2><p>例：查看mysql库各表容量大小</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">select</span><br><span class="line">table_schema as &#x27;数据库&#x27;,</span><br><span class="line">table_name as &#x27;表名&#x27;,</span><br><span class="line">table_rows as &#x27;记录数&#x27;,</span><br><span class="line">truncate(data_length/1024/1024, 2) as &#x27;数据容量(MB)&#x27;,</span><br><span class="line">truncate(index_length/1024/1024, 2) as &#x27;索引容量(MB)&#x27;</span><br><span class="line">from information_schema.tables</span><br><span class="line">where table_schema=&#x27;mysql&#x27;</span><br><span class="line">order by data_length desc, index_length desc;</span><br></pre></td></tr></table></figure>


<p>&gt; 原文地址：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/--smile/p/11451238.html">https://www.cnblogs.com/--smile/p/11451238.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-16T15:43:03.000Z" title="2021/6/16 下午11:43:03">2021-06-16</time>发表</span><span class="level-item"><time dateTime="2022-09-10T15:51:57.178Z" title="2022/9/10 下午11:51:57">2022-09-10</time>更新</span><span class="level-item">1 小时读完 (大约7761个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/16/Nginx-%E5%9F%BA%E7%A1%80%E6%80%BB%E7%BB%93/">Nginx-基础总结</a></h1><div class="content"><p>原文地址：<a target="_blank" rel="noopener" href="https://www.mwbo.com/133.html">https://www.mwbo.com/133.html</a></p>
<h1 id="常规配置模板"><a href="#常规配置模板" class="headerlink" title="常规配置模板"></a>常规配置模板</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">#user  www www;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log  /home/wwwlogs/nginx_error.log crit;</span><br><span class="line">#pid        /usr/local/nginx/nginx.pid;</span><br><span class="line"></span><br><span class="line">#Specifies the value for maximum file descriptors that can be opened by this process.</span><br><span class="line">worker_rlimit_nofile 655350;</span><br><span class="line"></span><br><span class="line">events</span><br><span class="line">	&#123;</span><br><span class="line">		use epoll;</span><br><span class="line">		worker_connections 655350;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">http</span><br><span class="line">	&#123;</span><br><span class="line">		include       mime.types;</span><br><span class="line">		default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">		server_names_hash_bucket_size 128;</span><br><span class="line">		client_header_buffer_size 32k;</span><br><span class="line">		large_client_header_buffers 4 32k;</span><br><span class="line">		client_max_body_size 50m;  # 如果报错413，可以尝试将这个参数改大</span><br><span class="line">		server_tokens off;</span><br><span class="line"></span><br><span class="line">		sendfile on;</span><br><span class="line">		tcp_nopush     on;</span><br><span class="line">		tcp_nodelay on;</span><br><span class="line">		keepalive_timeout 60;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		fastcgi_connect_timeout 300;</span><br><span class="line">		fastcgi_send_timeout 300;</span><br><span class="line">		fastcgi_read_timeout 300;</span><br><span class="line">		fastcgi_buffer_size 64k;</span><br><span class="line">		fastcgi_buffers 4 64k;</span><br><span class="line">		fastcgi_busy_buffers_size 128k;</span><br><span class="line">		fastcgi_temp_file_write_size 256k;</span><br><span class="line">		proxy_connect_timeout 600;</span><br><span class="line">		proxy_read_timeout 600;</span><br><span class="line">		proxy_send_timeout 600;</span><br><span class="line">		proxy_buffer_size 64k;</span><br><span class="line">		proxy_buffers   4 32k;</span><br><span class="line">		proxy_busy_buffers_size 64k;</span><br><span class="line">		proxy_temp_file_write_size 64k;</span><br><span class="line"></span><br><span class="line">		gzip on;</span><br><span class="line">		gzip_min_length  1k;</span><br><span class="line">		gzip_buffers     4 16k;</span><br><span class="line">		gzip_http_version 1.0;</span><br><span class="line">		gzip_comp_level 2;</span><br><span class="line">		gzip_types 	 text/plain application/x-javascript text/css application/xml text/xml application/json;</span><br><span class="line">		gzip_vary on;</span><br><span class="line">		log_format  access &#x27;$remote_addr - $remote_user [$time_local] $host &#x27;</span><br><span class="line">                                   &#x27;&quot;$request&quot; $status $body_bytes_sent $request_time &#x27;</span><br><span class="line">                                   &#x27;&quot;$http_referer&quot; &quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><br><span class="line">                                   &#x27;$upstream_addr $upstream_status $upstream_response_time&#x27; ;</span><br><span class="line"></span><br><span class="line"> #设置Web缓存区名称为cache_one，内存缓存空间大小为256MB，1天没有被访问的内容自动清除，硬盘缓存空间大小为30GB。</span><br><span class="line">		proxy_temp_path   /home/proxy_temp_dir;</span><br><span class="line">		proxy_cache_path  /home/proxy_cache_path levels=1:2 keys_zone=cache_one:256m inactive=1d max_size=30g;</span><br><span class="line"></span><br><span class="line">        server &#123;</span><br><span class="line">            listen 80;</span><br><span class="line">            server_name  _;</span><br><span class="line">            return 403;</span><br><span class="line">        &#125;</span><br><span class="line">        include vhost/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以“exmaple.org”为例，如下为基于 upstream 负载均衡模式的配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">upstream example_backend &#123;</span><br><span class="line">        server   127.0.0.1:9080;</span><br><span class="line">        server   192.168.1.198:9080;</span><br><span class="line">        server 172.16.0.4:80 weight=5 max_fails=3 fail_timeout=10s; # 权重、健康监测</span><br><span class="line">        server 172.16.0.5:8080 backup; # 备份节点,</span><br><span class="line">        ip_hash;  #调度算法</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name www.example.org example.com .example.org;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line"># 如果后端服务器出现502 或504错误代码的话nginx就不会请求某台服务器了,当后端服务器又工作正常了,nginx继续请求,这样一来达到了后端服务器健康状况检测的功能,</span><br><span class="line">        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;</span><br><span class="line">        proxy_pass http://example_backend;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header        Host    $host;</span><br><span class="line">        proxy_set_header        X-Real-IP       $remote_addr;</span><br><span class="line">        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">        # 设置后端连接超时时间</span><br><span class="line">        proxy_connect_timeout   600;</span><br><span class="line">        proxy_read_timeout  600;</span><br><span class="line">        proxy_send_timeout  600;</span><br><span class="line">        proxy_buffer_size   8k;</span><br><span class="line">        proxy_temp_file_write_size  64k;</span><br><span class="line"></span><br><span class="line">        # nginx本地cache开启</span><br><span class="line">        proxy_cache cache_one;</span><br><span class="line">        proxy_cache_valid 200 304 30d;</span><br><span class="line">        proxy_cache_valid 301 302 404 1m;</span><br><span class="line">        proxy_cache_valid any 1m;</span><br><span class="line">        proxy_cache_key $host$request_uri;</span><br><span class="line"></span><br><span class="line">        # 客户端缓存，在header中增加“Expires”</span><br><span class="line">        expires 30d;</span><br><span class="line">        add_header Cache-Control public;</span><br><span class="line">        add_header X-Proxy-Cache $upstream_cache_status;</span><br><span class="line"></span><br><span class="line">        proxy_set_header If-Modified-Since $http_if_modified_since;</span><br><span class="line">        if_modified_since before;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ .*\.(gif|jpg|jpeg|png|bmp|ico|swf|xml|css|js)$ &#123;</span><br><span class="line">        proxy_pass      http://example_backend;</span><br><span class="line">        proxy_set_header        Host    $host;</span><br><span class="line">        proxy_set_header        X-Real-IP       $remote_addr;</span><br><span class="line">        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        expires 15d;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ .*\.(jhtml)$ &#123;</span><br><span class="line">        proxy_pass      http://example_backend;</span><br><span class="line">        proxy_set_header        Host    $host;</span><br><span class="line">        proxy_set_header        X-Real-IP       $remote_addr;</span><br><span class="line">        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        expires -1;</span><br><span class="line">    &#125;</span><br><span class="line">    access_log  logs/www.example.org.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他的 proxy 配置：</p>
<p>1.proxy_set_header :在将客户端请求发送给后端服务器之前，更改来自客户端的请求头信息。<br>2.proxy_connect_timeout:配置Nginx与后端代理服务器尝试建立连接的超时时间。<br>3.proxy_read_timeout : 配置Nginx向后端服务器组发出read请求后，等待相应的超时时间。<br>4.proxy_send_timeout：配置Nginx向后端服务器组发出write请求后，等待相应的超时时间。<br>5.proxy_redirect :用于修改后端服务器返回的响应头中的Location和Refresh。</p>
<h1 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># htpasswd -bc /usr/local/nginx/auth/passwd admin 123456</span><br><span class="line">vim /usr/local/nginx/conf/vhost/www.conf</span><br><span class="line">server &#123;</span><br><span class="line">        listen   80;</span><br><span class="line">        server_name www.com;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        root /www;</span><br><span class="line">location / &#123;</span><br><span class="line">         auth_basic &quot;test&quot;;</span><br><span class="line">         auth_basic_user_file /usr/local/nginx/auth/passwd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#service nginx restart</span><br></pre></td></tr></table></figure>

<h1 id="解决跨域"><a href="#解决跨域" class="headerlink" title="解决跨域"></a>解决跨域</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># 提示： add_header 也可以添加到 server 中，这样当前 server 下都允许跨域</span><br><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">    listen 3002;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    location /ok &#123;</span><br><span class="line">        proxy_pass http://localhost:3000;</span><br><span class="line"></span><br><span class="line">        #   指定允许跨域的方法，*代表所有</span><br><span class="line">        add_header Access-Control-Allow-Methods *;</span><br><span class="line"></span><br><span class="line">        #   预检命令的缓存，如果不缓存每次会发送两次请求</span><br><span class="line">        add_header Access-Control-Max-Age 3600;</span><br><span class="line"></span><br><span class="line">        #   带cookie请求需要加上这个字段，并设置为true</span><br><span class="line">        add_header Access-Control-Allow-Credentials true;</span><br><span class="line"></span><br><span class="line">        #   表示允许这个域跨域调用（客户端发送请求的域名和端口）</span><br><span class="line">        #   $http_origin动态获取请求客户端请求的域   不用*的原因是带cookie的请求不支持*号</span><br><span class="line">        add_header Access-Control-Allow-Origin $http_origin;</span><br><span class="line"></span><br><span class="line">        #   表示请求头的字段 动态获取</span><br><span class="line">        add_header Access-Control-Allow-Headers $http_access_control_request_headers;</span><br><span class="line"></span><br><span class="line">        #   OPTIONS预检命令，预检命令通过时才发送请求</span><br><span class="line">        #   检查请求的类型是不是预检命令</span><br><span class="line">        if ($request_method = OPTIONS)&#123;</span><br><span class="line">            return 200;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="URL-重写"><a href="#URL-重写" class="headerlink" title="URL 重写"></a>URL 重写</h1><p>比如说访问某站点的路径为&#x2F;forum&#x2F; , 此时想使用&#x2F;bbs 来访问此站点需要做 url 重写如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	rewrite ^/forum/?$ /bbs/ permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如说某站点有个图片服务器(10.0.0.1&#x2F;p_w_picpaths&#x2F; ) 此时访问某站点上&#x2F;p_w_picpaths&#x2F;的资源时希望访问到图片服务器上的资源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	rewrite ^/p_w_picpaths/(.*\.jpg)$  /p_w_picpaths2/$1 break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="域名跳转"><a href="#域名跳转" class="headerlink" title="域名跳转"></a>域名跳转</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.com;</span><br><span class="line">    rewrite ^/ http://www.www.com/;</span><br><span class="line">    # return 301 http://www.andy.com/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($host != &#x27;www.xyz.com&#x27;) &#123;         ####注意，这里很严格，if后面要有空格，!=两边都是空格。</span><br><span class="line">   rewrite ^/(.*)$ http://www.xyz.com/$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="域名镜像"><a href="#域名镜像" class="headerlink" title="域名镜像"></a>域名镜像</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name  www.com;</span><br><span class="line">    rewrite ^/(.*)$ http://www.www.com/$1 last;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>判断表达式</p>
<p>-f 和 !-f 用来判断是否存在文件</p>
<p>-d 和 !-d 用来判断是否存在目录</p>
<p>-e 和 !-e 用来判断是否存在文件或目录</p>
<p>-x 和 !-x 用来判断文件是否可执行</p>
<h1 id="防盗链"><a href="#防盗链" class="headerlink" title="防盗链"></a>防盗链</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.(gif|jpg|png|swf|flv)$ &#123;</span><br><span class="line">  valid_referers none blocked www.com;</span><br><span class="line">  if ($invalid_referer) &#123;</span><br><span class="line">    rewrite ^/ http://www.com/403.html;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h1 id="会话保持"><a href="#会话保持" class="headerlink" title="会话保持"></a>会话保持</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ip_hash使用源地址哈希算法，将同一客户端的请求只发往同一个后端服务器（除非该服务器不可用）。</span><br><span class="line"># 问题： 当后端服务器宕机后，session会话丢失；同一客户端会被转发到同一个后端服务器，可能导致负载失衡；</span><br><span class="line">upstream backend &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server backend1.example.com;</span><br><span class="line">    server backend2.example.com;</span><br><span class="line">    server backend3.example.com down;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sticky_cookie_insert</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 使用sticky_cookie_insert 启用会话亲缘关系，会导致来自同一客户端的请求被传递到一组服务器的同一台服务器。与ip_hash不同之处在于，它不是基于IP来判断客户端的，而是基于cookie来判断。因此可以避免上述ip_hash中来自同一客户端导致负载失衡的情况(需要引入第三方模块才能实现)。</span><br><span class="line">upstream backend &#123;</span><br><span class="line">    server backend1.example.com;</span><br><span class="line">    server backend2.example.com;</span><br><span class="line">    sticky_cookie_insert srv_id expires=1h domain=3evip.cn path=/;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name 3evip.cn;</span><br><span class="line">    location / &#123;</span><br><span class="line">    	proxy_pass http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>expires：设置浏览器中保持 cookie 的时间<br>domain：定义 cookie 的域<br>path：为 cookie 定义路径</p>
<h1 id="日志切割"><a href="#日志切割" class="headerlink" title="日志切割"></a>日志切割</h1><p><strong>示列一</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># 适合单个网站日志文件</span><br><span class="line"></span><br><span class="line">LOGS_PATH=/home/wwwroot/yunwei/logs</span><br><span class="line">yesterday=`date  +&quot;%F&quot; -d  &quot;-1 days&quot;`</span><br><span class="line">mv $&#123;LOGS_PATH&#125;/yunwei.log  $&#123;LOGS_PATH&#125;/yunwei-$&#123;yesterday&#125;.log</span><br><span class="line">kill -USR1 $(cat /var/logs/nginx.pid)</span><br></pre></td></tr></table></figure>

<p><strong>示列二</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#nginx日志切割</span><br><span class="line"></span><br><span class="line"># Nginx pid</span><br><span class="line">NGINX_PID=$(cat /var/logs/nginx.pid)</span><br><span class="line"></span><br><span class="line"># 多个日志文件</span><br><span class="line">LOGS=(xxx.access.log xxx.access.log)</span><br><span class="line"></span><br><span class="line"># Nginx日志路径目录</span><br><span class="line">BASH_PATH=&quot;/www/wwwlogs&quot;</span><br><span class="line"></span><br><span class="line"># xxxx年xx月</span><br><span class="line">lOG_PATH=$(date -d yesterday +&quot;%Y%m&quot;)</span><br><span class="line"></span><br><span class="line"># 昨天日期</span><br><span class="line">DAY=$(date -d yesterday +&quot;%d&quot;)</span><br><span class="line"></span><br><span class="line"># 循环移动</span><br><span class="line">for log in $&#123;LOGS[@]&#125;</span><br><span class="line">do</span><br><span class="line">	# 先判断日志目录是否存在</span><br><span class="line">    [[ ! -d &quot;$&#123;BASH_PATH&#125;/$&#123;lOG_PATH&#125;&quot; ]] &amp;&amp; mkdir -p $&#123;BASH_PATH&#125;/$&#123;lOG_PATH&#125;</span><br><span class="line"></span><br><span class="line">    # 进入日志目录</span><br><span class="line">    cd $&#123;BASH_PATH&#125;</span><br><span class="line">    mv $&#123;log&#125; $&#123;lOG_PATH&#125;/$&#123;DAY&#125;-$&#123;log&#125;</span><br><span class="line">    #kill -USR1 `ps axu | grep &quot;nginx: master process&quot; | grep -v grep | awk &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">    kill -USR1 $&#123;NGINX_PID&#125;</span><br><span class="line"></span><br><span class="line">    # 删除30天的备份,最好是移动到其他位置，不建议 rm -fr</span><br><span class="line">    #find $&#123;BASH_PATH&#125;/$&#123;lOG_PATH&#125; -mtime +30 -name &quot;.&quot; -exec rm -fr &#123;&#125; \;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p><strong>示列三</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">#set the path to nginx log files</span><br><span class="line">log_files_path=&quot;/usr/local/nginx/logs/&quot;</span><br><span class="line">log_files_dir=$&#123;log_files_path&#125;$(date -d &quot;yesterday&quot; +&quot;%Y&quot;)/$(date -d &quot;yesterday&quot; +&quot;%m&quot;)</span><br><span class="line">#set nginx log files you want to cut</span><br><span class="line">log_files_name=(gw20 gw20-json)</span><br><span class="line">#set the path to nginx.</span><br><span class="line">nginx_sbin=&quot;/usr/bin/nginx&quot;</span><br><span class="line">#Set how long you want to save</span><br><span class="line">save_days=10</span><br><span class="line"></span><br><span class="line">############################################</span><br><span class="line">#Please do not modify the following script #</span><br><span class="line">############################################</span><br><span class="line">mkdir -p $log_files_dir</span><br><span class="line"></span><br><span class="line">log_files_num=$&#123;#log_files_name[@]&#125;</span><br><span class="line"></span><br><span class="line">#cut nginx log files</span><br><span class="line">for((i=0;i&lt;$log_files_num;i++));do</span><br><span class="line">mv $&#123;log_files_path&#125;$&#123;log_files_name[i]&#125;.log $&#123;log_files_dir&#125;/$&#123;log_files_name[i]&#125;_$(date -d &quot;yesterday&quot; +&quot;%Y%m%d&quot;).log</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">#delete 30 days ago nginx log files</span><br><span class="line">find $log_files_path -mtime +$save_days -exec rm -rf &#123;&#125; \;</span><br><span class="line"></span><br><span class="line">$nginx_sbin -s reload</span><br></pre></td></tr></table></figure>

<p><strong>示列四</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line"></span><br><span class="line">    if ($time_iso8601 ~ &#x27;(\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;)&#x27;) &#123;</span><br><span class="line">        set $day $1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	access_log  /www/wwwlogs/xxx.com-$day.log main;</span><br><span class="line">	error_log  /www/wwwlogs/xxx.com.error.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>动静分离</p>
<p>为加快网站解析速度，可以把动态页面和静态页面由不同的服务器来解析，加快解析速度。降低原来单个服务器的压力。 在动静分离的 tomcat 的时候比较明显，因为 tomcat 解析静态很慢，简单来说，是使用正则表达式匹配过滤，交给不同的服务器。</p>
<p>1、准备环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.62.159 代理服务器</span><br><span class="line">192.168.62.157 动态资源</span><br><span class="line">192.168.62.155 静态资源</span><br></pre></td></tr></table></figure>

<p>2、配置 nginx 反向代理 upstream</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx-server conf.d]# cat upstream.conf</span><br><span class="line"></span><br><span class="line">upstream static &#123;</span><br><span class="line">    server 192.168.62.155:80 weight=1 max_fails=1 fail_timeout=60s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream phpserver &#123;</span><br><span class="line">    server 192.168.62.157:80 weight=1 max_fails=1 fail_timeout=60s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">   listen      80;</span><br><span class="line">   server_name     localhost;</span><br><span class="line"></span><br><span class="line">   #动态资源加载</span><br><span class="line">   location ~ \.(php|jsp)$ &#123;</span><br><span class="line">       proxy_pass http://phpserver;</span><br><span class="line">       proxy_set_header Host $host:$server_port;</span><br><span class="line">       proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   #静态资源加载</span><br><span class="line">   location ~ .*\.(html|gif|jpg|png|bmp|swf|css|js)$ &#123;</span><br><span class="line">       proxy_pass http://static;</span><br><span class="line">       proxy_set_header Host $host:$server_port;</span><br><span class="line">       proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、192.168.62.155 静态资源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#静态资源配置</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name     localhost;</span><br><span class="line"></span><br><span class="line">    location ~ \.(html|jpg|png|js|css|gif|bmp|jpeg) &#123;</span><br><span class="line">        root /home/www/nginx;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、192.168.62.157 动态资源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen      80;</span><br><span class="line">    server_name     localhost;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        root           /home/nginx/html;  #指定网站目录</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;    #指定访问地址</span><br><span class="line">        fastcgi_index  index.php;       #指定默认文件</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name; #站点根目录，取决于root配置项</span><br><span class="line">        include        fastcgi_params;  #包含nginx常量定义</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="location-优先级"><a href="#location-优先级" class="headerlink" title="location 优先级"></a>location 优先级</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">当有多条 location 规则时，nginx 有一套比较复杂的规则，优先级如下：</span><br><span class="line">`精确匹配=</span><br><span class="line">`前缀匹配^~（立刻停止后续的正则搜索）</span><br><span class="line">`按文件中顺序的正则匹配~或~*</span><br><span class="line">`匹配不带任何修饰的前缀匹配。</span><br><span class="line"></span><br><span class="line">这个规则大体的思路是</span><br><span class="line">`先精确匹配，没有则查找带有^~的前缀匹配，没有则进行正则匹配，最后才返回前缀匹配的结果（如果有的话）</span><br></pre></td></tr></table></figure>

<h2 id="HTTPS-使用自颁发证书实现"><a href="#HTTPS-使用自颁发证书实现" class="headerlink" title="HTTPS 使用自颁发证书实现"></a>HTTPS 使用自颁发证书实现</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 建立存放https证书的目录</span><br><span class="line">mkdir -pv /usr/local/nginx/conf/.sslkey</span><br><span class="line"># 生成网站私钥文件</span><br><span class="line">cd /usr/local/nginx/conf/.sslkey</span><br><span class="line">openssl genrsa -out https.key 1024</span><br><span class="line"># 生存网站证书文件,需要注意的是在生成的过程中需要输入一些信息根据自己的需要输入,但Common Name 项输入的必须是访问网站的FQDN</span><br><span class="line">openssl req -new -x509 -key https.key -out https.crt</span><br><span class="line"># 为了安全起见,将存放证书的目录权限设置为400</span><br><span class="line">chmod -R 400 /usr/local/nginx/conf/.sslkey</span><br><span class="line"></span><br><span class="line">#vim /usr/local/nginx/conf/vhost/www.conf</span><br><span class="line">server &#123;</span><br><span class="line">        listen   443;</span><br><span class="line">        server_name www.com;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        root /www;</span><br><span class="line">        ssl                 on;</span><br><span class="line">        ssl_protocols       SSLv3 TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">        ssl_ciphers         AES128-SHA:AES256-SHA:RC4-SHA:DES-CBC3-SHA:RC4-MD5;</span><br><span class="line">        ssl_certificate     /usr/local/nginx/conf/.sslkey/https.crt;</span><br><span class="line">        ssl_certificate_key /usr/local/nginx/conf/.sslkey/https.key;</span><br><span class="line">        ssl_session_cache   shared:SSL:10m;</span><br><span class="line">        ssl_session_timeout 10m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#重新启动nginx服务</span><br><span class="line">service nginx restar</span><br></pre></td></tr></table></figure>

<h2 id="基于-HTTPS-配置核心配置"><a href="#基于-HTTPS-配置核心配置" class="headerlink" title="基于 HTTPS 配置核心配置"></a>基于 HTTPS 配置核心配置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">upstream example_backend &#123;</span><br><span class="line">    server   127.0.0.1:9080;</span><br><span class="line">    server   192.168.1.198:9080;</span><br><span class="line"> &#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name www.example.org example.org;</span><br><span class="line">        rewrite ^/(.*)$  https://$host/$1 last;</span><br><span class="line"> &#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name www.example.org example.org;</span><br><span class="line"></span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_certificate      /usr/local/nginx/conf/ssl/example.crt;</span><br><span class="line">    ssl_certificate_key  /usr/local/nginx/conf/ssl/example.key;</span><br><span class="line">    ssl_session_timeout  5m;</span><br><span class="line">    ssl_protocols  SSLv3 TLSv1 TLSv1.2 TLSv1.1;</span><br><span class="line">    ssl_ciphers HIGH:!aNULL:!MD5:!EXPORT56:!EXP;</span><br><span class="line">    ssl_prefer_server_ciphers   on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="根据页面不存在则自定义跳转"><a href="#根据页面不存在则自定义跳转" class="headerlink" title="根据页面不存在则自定义跳转"></a>根据页面不存在则自定义跳转</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (!-f $request_filename) &#123;</span><br><span class="line">      rewrite ^(/.*)$ http://www.com permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="直接输出消息"><a href="#直接输出消息" class="headerlink" title="直接输出消息"></a>直接输出消息</h2><h3 id="直接返回文本："><a href="#直接返回文本：" class="headerlink" title="直接返回文本："></a>直接返回文本：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	default_type    text/plain;</span><br><span class="line">	return 502 &quot;服务正在升级，请稍后再试……&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="也可以使用html标签格式："><a href="#也可以使用html标签格式：" class="headerlink" title="也可以使用html标签格式："></a>也可以使用html标签格式：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	default_type    text/html;</span><br><span class="line">	return 502 &quot;服务正在升级，请稍后再试……&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="也可以直接返回json文本："><a href="#也可以直接返回json文本：" class="headerlink" title="也可以直接返回json文本："></a>也可以直接返回json文本：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	default_type    application/json;</span><br><span class="line">	return 502 &#x27;&#123;&quot;status&quot;:502,&quot;msg&quot;:&quot;服务正在升级，请稍后再试……&quot;&#125;&#x27;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="根据文件类型设置过期时间"><a href="#根据文件类型设置过期时间" class="headerlink" title="根据文件类型设置过期时间"></a>根据文件类型设置过期时间</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.(js|css|jpg|jpeg|gif|png|swf)$ &#123;</span><br><span class="line">    if (-f $request_filename) &#123;</span><br><span class="line">        expires 1h;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="根据域名自定义跳转"><a href="#根据域名自定义跳转" class="headerlink" title="根据域名自定义跳转"></a>根据域名自定义跳转</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ( $host = &#x27;www.baidu.com&#x27; ) &#123;</span><br><span class="line">	rewrite ^/(.*)$ http://baidu.com/$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="浏览器的类型-作出相应的跳转"><a href="#浏览器的类型-作出相应的跳转" class="headerlink" title="浏览器的类型,作出相应的跳转"></a>浏览器的类型,作出相应的跳转</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 根据浏览器头部 URL 重写到指定目录</span><br><span class="line">if ($http_user_agent ~* MSIE) &#123;</span><br><span class="line">	rewrite  ^(.*)$  /msie/$1  break;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 判断是否是手机端</span><br><span class="line">if ( $http_user_agent ~* &quot;(Android|iPhone|Windows Phone|UC|Kindle)&quot; ) &#123;</span><br><span class="line">	rewrite ^/(.*)$ http://m.qp.com$uri redirect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="禁止访问目录-文件"><a href="#禁止访问目录-文件" class="headerlink" title="禁止访问目录|文件"></a>禁止访问目录|文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.(txt|doc)$&#123;</span><br><span class="line">    root /data/www/wwwroot/linuxtone/test;</span><br><span class="line">    deny all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果前端是反向代理的情况下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">location /admin/ &#123;</span><br><span class="line">	allow 192.168.1.0/24;</span><br><span class="line">	deny all;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 后端</span><br><span class="line"># set $allow false;</span><br><span class="line"># if ($allow = false) &#123; return 403;&#125;</span><br><span class="line">if ($http_x_forwarded_for !~* ^192\.168\.1\.*) &#123;</span><br><span class="line">	return 403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="添加模块–支持-Websock"><a href="#添加模块–支持-Websock" class="headerlink" title="添加模块–支持 Websock"></a>添加模块–支持 Websock</h2><p>Nginx 动态添加模块</p>
<p>版本平滑升级，和添加模块操作类似</p>
<h2 id="准备模块"><a href="#准备模块" class="headerlink" title="准备模块"></a>准备模块</h2><p>这里以 nginx-push-stream-module 为例,模块我放在 &#x2F;data&#x2F;module 下，你也可以放在其他位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/module &amp;&amp; cd /data/module/</span><br><span class="line">git clone http://github.com/wandenberg/nginx-push-stream-module.git</span><br></pre></td></tr></table></figure>

<h2 id="查看-Nginx-已安装模块"><a href="#查看-Nginx-已安装模块" class="headerlink" title="查看 Nginx 已安装模块"></a>查看 Nginx 已安装模块</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -V</span><br><span class="line">--prefix=/usr/local/nginx --user=www --group=www --with-http_ssl_module --with-http_stub_status_module --with-http_gzip_static_module --with-http_flv_module --with-http_mp4_module --with-pcre</span><br></pre></td></tr></table></figure>

<h2 id="备份源执行文件"><a href="#备份源执行文件" class="headerlink" title="备份源执行文件"></a>备份源执行文件</h2><p>备份原来的 nginx 可执行文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx_bak</span><br><span class="line">#　有必要的话，可以再备份下配置文件，以防万一</span><br></pre></td></tr></table></figure>

<h2 id="下载源码编译"><a href="#下载源码编译" class="headerlink" title="下载源码编译"></a>下载源码编译</h2><p>下载相同版本的 Nginx 源码包编译（以前安装时的源码包），如果已经删除了可重新下载，版本相同即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.16.1.tar.gz</span><br><span class="line">tar xf nginx-1.16.1.tar.gz</span><br><span class="line">cd nginx-1.16.1</span><br><span class="line"> ./configure --prefix=/usr/local/nginx --user=www --group=www --with-http_ssl_module --with-http_stub_status_module --with-http_gzip_static_module --with-http_flv_module --with-http_mp4_module --with-pcre --add-module=/data/module/nginx-push-stream-module</span><br><span class="line"></span><br><span class="line"># 编译Nginx（千万不要make install，不然就真的覆盖了）</span><br><span class="line">make</span><br><span class="line">mv objs/nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure>

<h2 id="查看是否安装"><a href="#查看是否安装" class="headerlink" title="查看是否安装"></a>查看是否安装</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -V</span><br><span class="line">--prefix=/usr/local/nginx --user=www --group=www --with-http_ssl_module --with-http_stub_status_module --with-http_gzip_static_module --with-http_flv_module --with-http_mp4_module --with-pcre --add-module=/data/module/nginx-push-stream-module</span><br></pre></td></tr></table></figure>

<h2 id="添加模块–支持健康检查模块"><a href="#添加模块–支持健康检查模块" class="headerlink" title="添加模块–支持健康检查模块"></a>添加模块–支持健康检查模块</h2><h2 id="缺陷？"><a href="#缺陷？" class="headerlink" title="缺陷？"></a>缺陷？</h2><p>自带健康检查的缺陷：</p>
<p>Nginx 只有当有访问时后，才发起对后端节点探测。<br>如果本次请求中，节点正好出现故障，Nginx 依然将请求转交给故障的节点,然后再转交给健康的节点处理。所以不会影响到这次请求的正常进行。但是会影响效率,因为多了一次转发<br>自带模块无法做到预警<br>被动健康检查<br>使用第三访模块 nginx_upstream_check_module：</p>
<p>区别于 nginx 自带的非主动式的心跳检测，淘宝开发的 tengine 自带了一个提供主动式后端服务器心跳检测模块<br>若健康检查包类型为 http，在开启健康检查功能后，nginx 会根据设置的间隔向指定的后端服务器端口发送健康检查包，并根据期望的 HTTP 回复状态码来判断服务是否健康。<br>后端真实节点不可用，则请求不会转发到故障节点<br>故障节点恢复后，请求正常转发</p>
<h2 id="准备模块-1"><a href="#准备模块-1" class="headerlink" title="准备模块"></a>准备模块</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install patch git -y</span><br><span class="line">cd /usr/local/src</span><br><span class="line">git clone https://github.com/yaoweibin/nginx_upstream_check_module.git</span><br></pre></td></tr></table></figure>

<h2 id="打补丁"><a href="#打补丁" class="headerlink" title="打补丁"></a>打补丁</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 需进入源码包打补丁</span><br><span class="line"># 个人习惯，源码放在 /usr/local/src</span><br><span class="line"># 例如我的 nginx 源码包存放： /usr/local/src/nginx-1.16.1 , 若源码已经删除，那么去官网上再下载同版本</span><br><span class="line">cd /usr/local/src/nginx-1.16.1</span><br><span class="line">patch -p1 &lt; ../nginx_upstream_check_module/check_1.16.1+.patch</span><br></pre></td></tr></table></figure>

<h2 id="重新编译"><a href="#重新编译" class="headerlink" title="重新编译"></a>重新编译</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">nginx -V</span><br><span class="line"># configure arguments: --prefix=/usr/local/nginx --user=www --group=www --with-http_ssl_module --with-http_stub_status_module --add-module=/root/nginx_upstream_check_module/</span><br><span class="line"></span><br><span class="line"># 在运行中的 nginx 添加模块； 首先一点: 修改东西之前要先备份</span><br><span class="line">mv /usr/loca/nginx/sbin/nginx&#123;,_bak&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/nginx \</span><br><span class="line">--user=www --group=www \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--add-module=../nginx_upstream_check_module</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># **别手贱， 千万不要 make install**</span><br><span class="line">cp objs/nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure>

<h2 id="查看模块"><a href="#查看模块" class="headerlink" title="查看模块"></a>查看模块</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -V</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --user=www --group=www --with-http_ssl_module --with-http_stub_status_module --add-module=../nginx_upstream_check_module</span><br></pre></td></tr></table></figure>

<h2 id="如何使用？"><a href="#如何使用？" class="headerlink" title="如何使用？"></a>如何使用？</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    upstream cluster &#123;</span><br><span class="line">        server 192.168.0.1:80;</span><br><span class="line">        server 192.168.0.2:80;</span><br><span class="line">	    server 127.0.0.1:80;</span><br><span class="line">        check interval=5000 rise=1 fall=3 timeout=4000;</span><br><span class="line"></span><br><span class="line">        #check interval=3000 rise=2 fall=5 timeout=1000 type=ssl_hello;</span><br><span class="line">        #check interval=3000 rise=2 fall=5 timeout=1000 type=http;</span><br><span class="line">        #check_http_send &quot;HEAD / HTTP/1.0\r\n\r\n&quot;;</span><br><span class="line">        #check_http_expect_alive http_2xx http_3xx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://cluster;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /status &#123;</span><br><span class="line">            # 默认html，请求方式： check_status html|json|xml;</span><br><span class="line">            # allow 允许的IP地址</span><br><span class="line">            check_status;</span><br><span class="line">            access_log   off;</span><br><span class="line">            allow SOME.IP.ADD.RESS;</span><br><span class="line">            deny all;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># kill -USER2 `cat /usr/local/nginx/logs/nginx.pid` #热升级nginx,如果当前nginx不是用绝对路径下的nginx命令启动的话，热升级无效。</span><br><span class="line"># 只能 `nginx -s stop` &amp;&amp; /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf`</span><br></pre></td></tr></table></figure>

<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># curl http://127.0.0.1/status?format=http</span><br><span class="line"># curl http://127.0.0.1/status?format=xml</span><br><span class="line">curl http://127.0.0.1/status?format=json</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">&#123;&quot;servers&quot;: &#123;</span><br><span class="line">  &quot;total&quot;: 3,</span><br><span class="line">  &quot;generation&quot;: 2,</span><br><span class="line">  &quot;server&quot;: [</span><br><span class="line">    &#123;&quot;index&quot;: 0, &quot;upstream&quot;: &quot;cluster&quot;, &quot;name&quot;: &quot;192.168.0.1:80&quot;, &quot;status&quot;: &quot;down&quot;, &quot;rise&quot;: 0, &quot;fall&quot;: 432, &quot;type&quot;: &quot;tcp&quot;, &quot;port&quot;: 0&#125;,</span><br><span class="line">    &#123;&quot;index&quot;: 1, &quot;upstream&quot;: &quot;cluster&quot;, &quot;name&quot;: &quot;192.168.0.2:80&quot;, &quot;status&quot;: &quot;down&quot;, &quot;rise&quot;: 0, &quot;fall&quot;: 432, &quot;type&quot;: &quot;tcp&quot;, &quot;port&quot;: 0&#125;,</span><br><span class="line">    &#123;&quot;index&quot;: 2, &quot;upstream&quot;: &quot;cluster&quot;, &quot;name&quot;: &quot;127.0.0.1:80&quot;, &quot;status&quot;: &quot;up&quot;, &quot;rise&quot;: 4, &quot;fall&quot;: 0, &quot;type&quot;: &quot;tcp&quot;, &quot;port&quot;: 0&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;&#125;</span><br><span class="line">&quot;&quot;&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://www.mwbo.com/wp-content/uploads/2021/06/6666.png" alt="img"></p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>如果后端是基于域名访问，可使用 check_http_send “GET &#x2F;xxx HTTP&#x2F;1.0\r\n HOST <a target="_blank" rel="noopener" href="http://www.xxx.com/r/n/r/n%E2%80%9D;%E6%96%B9%E5%BC%8F%E5%9C%A8%E8%AF%B7%E6%B1%82%E6%97%B6%E6%B7%BB%E5%8A%A0%E8%AF%B7%E6%B1%82%E5%A4%B4%E4%BF%A1%E6%81%AF">www.xxx.com\r\n\r\n”;方式在请求时添加请求头信息</a></p>
<h2 id="参数详解"><a href="#参数详解" class="headerlink" title="参数详解"></a>参数详解</h2><p>interval： 检测间隔 3 秒<br>fall: 连续检测失败次数 5 次时，认定 relaserver is down<br>rise: 连续检测成功 2 次时，认定 relaserver is up<br>timeout: 超时 1 秒<br>default_down: 初始状态为 down,只有检测通过后才为 up<br>type: 检测类型方式 tcp<br>tcp :tcp 套接字,不建议使用，后端业务未 100%启动完成,前端已经放开访问的情况<br>ssl_hello： 发送 hello 报文并接收 relaserver 返回的 hello 报文<br>http: 自定义发送一个请求，判断上游 relaserver 接收并处理<br>mysql: 连接到 mysql 服务器，判断上游 relaserver 是否还存在<br>ajp: 发送 AJP Cping 数据包，接收并解析 AJP Cpong 响应以诊断上游 relaserver 是否还存活(AJP tomcat 内置的一种协议)<br>fastcgi: php 程序是否存活</p>
<h2 id="GIthub-地址"><a href="#GIthub-地址" class="headerlink" title="GIthub 地址"></a>GIthub 地址</h2><p><a target="_blank" rel="noopener" href="https://www.mwbo.com/?golink=aHR0cHM6Ly9naXRodWIuY29tL3lhb3dlaWJpbi9uZ2lueF91cHN0cmVhbV9jaGVja19tb2R1bGU=">https://github.com/yaoweibin/nginx_upstream_check_module</a></p>
<h2 id="添加模块–支持国家城市模块"><a href="#添加模块–支持国家城市模块" class="headerlink" title="添加模块–支持国家城市模块"></a>添加模块–支持国家城市模块</h2><p>安装依赖 libmaxmindd</p>
<p>因为需要读取在 GeoIP2 的 IP 数据库库，需要使用到 libmaxminddb 中的一个 C 库</p>
<p><strong>pay源码</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/maxmind/libmaxminddb/releases/download/1.3.2/libmaxminddb-1.3.2.tar.gz</span><br><span class="line">tar zxvf libmaxminddb-1.3.2.tar.gz</span><br><span class="line">cd libmaxminddb-1.3.2</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make  install</span><br><span class="line"></span><br><span class="line"># 添加库路径并更新库</span><br><span class="line">sh -c &quot;echo /usr/local/lib  &gt;&gt; /etc/ld.so.conf.d/local.conf&quot;</span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure>

<p><strong>yum</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install libmaxminddb-devel -y</span><br></pre></td></tr></table></figure>

<h2 id="下载-GeoIP-源码"><a href="#下载-GeoIP-源码" class="headerlink" title="下载 GeoIP 源码"></a>下载 GeoIP 源码</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/leev/ngx_http_geoip2_module/archive/3.2.tar.gz</span><br><span class="line">tar zxvf 3.2.tar.gz</span><br></pre></td></tr></table></figure>

<h2 id="Nginx-重新编译"><a href="#Nginx-重新编译" class="headerlink" title="Nginx 重新编译"></a>Nginx 重新编译</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> ./configure --prefix=/usr/local/nginx --add-module=../ngx_http_geoip2_module-3.2</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h2 id="下载-GeoLite"><a href="#下载-GeoLite" class="headerlink" title="下载 GeoLite"></a>下载 GeoLite</h2><p>这个库是为了将 IP 地址翻译成具体的地址信息，下载需要注册…<br>URL: <a target="_blank" rel="noopener" href="https://www.maxmind.com/en/accounts/current/people/current">https://www.maxmind.com/en/accounts/current/people/current</a> 账号： <a href="mailto:&#120;&#x78;&#x78;&#x78;&#x40;&#113;&#113;&#x2e;&#99;&#x6f;&#109;">&#120;&#x78;&#x78;&#x78;&#x40;&#113;&#113;&#x2e;&#99;&#x6f;&#109;</a> 密码： xxx..</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gunzip GeoLite2-City.mmdb.gz</span><br><span class="line">gunzip GeoLite2-Country.mmdb.gz</span><br><span class="line">mkdir /data/geoip</span><br><span class="line">mv GeoLite2-City.mmdb  /data/geoip/city.mmdb</span><br><span class="line">mv GeoLite2-Country.mmdb /data/geoip/country.mmdb</span><br></pre></td></tr></table></figure>

<h2 id="启用-GeoIP"><a href="#启用-GeoIP" class="headerlink" title="启用 GeoIP"></a>启用 GeoIP</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/nginx/conf/nginx.conf</span><br><span class="line">http &#123;</span><br><span class="line">    geoip2 /data/geoip/country.mmdb &#123;</span><br><span class="line">        $geoip2_data_country_code default=CN country iso_code;</span><br><span class="line">        $geoip2_data_country_name country names en;</span><br><span class="line">    &#125;</span><br><span class="line">    geoip2 /data/geoip/city.mmdb &#123;</span><br><span class="line">        $geoip2_data_city_name default=Shenzhen city names en;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">            add_header geoip2_data_country_code $geoip2_data_country_code;</span><br><span class="line">            add_header geoip2_data_city_name $geoip2_data_city_name;</span><br><span class="line">            if ($geoip2_data_country_code = CN)&#123;</span><br><span class="line">                root /data/webroot/cn;</span><br><span class="line">            &#125;</span><br><span class="line">            if ($geoip2_data_country_code = US)&#123;</span><br><span class="line">                root /data/webroot/us;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>

<h2 id="检查-GeoIP"><a href="#检查-GeoIP" class="headerlink" title="检查 GeoIP"></a>检查 GeoIP</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/webroot/us</span><br><span class="line">mkdir /data/webroot/cn</span><br><span class="line">echo &quot;US Site&quot; &gt; /data/webroot/us/index.html</span><br><span class="line">echo &quot;CN Site&quot; &gt; /data/webroot/cn/index.html</span><br><span class="line">curl 试一试</span><br></pre></td></tr></table></figure>

<h2 id="内置变量"><a href="#内置变量" class="headerlink" title="内置变量"></a>内置变量</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">http://wiki.nginx.org/HttpCoreModule#Variables   官方文档</span><br><span class="line">$arg_PARAMETER</span><br><span class="line">$args</span><br><span class="line">$binary_remote_addr</span><br><span class="line">$body_bytes_sent</span><br><span class="line">$content_length</span><br><span class="line">$content_type</span><br><span class="line">$cookie_COOKIE</span><br><span class="line">$document_root</span><br><span class="line">$document_uri</span><br><span class="line">$host</span><br><span class="line">$hostname</span><br><span class="line">$http_HEADER</span><br><span class="line">$sent_http_HEADER</span><br><span class="line">$is_args</span><br><span class="line">$limit_rate</span><br><span class="line">$nginx_version</span><br><span class="line">$query_string</span><br><span class="line">$remote_addr</span><br><span class="line">$remote_port</span><br><span class="line">$remote_user</span><br><span class="line">$request_filename</span><br><span class="line">$request_body</span><br><span class="line">$request_body_file</span><br><span class="line">$request_completion</span><br><span class="line">$request_method</span><br><span class="line">$request_uri</span><br><span class="line">$scheme</span><br><span class="line">$server_addr</span><br><span class="line">$server_name</span><br><span class="line">$server_port</span><br><span class="line">$server_protocol</span><br><span class="line">$uri</span><br></pre></td></tr></table></figure>

<h1 id="nginx配置location"><a href="#nginx配置location" class="headerlink" title="nginx配置location"></a>nginx配置location</h1><p>基本语法：location [&#x3D;||*|^~] &#x2F;uri&#x2F; { … }</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">= 严格匹配。如果这个查询匹配，那么将停止搜索并立即处理此请求。</span><br><span class="line">~ 为区分大小写匹配(可用正则表达式)</span><br><span class="line">!~为区分大小写不匹配</span><br><span class="line">~* 为不区分大小写匹配(可用正则表达式)</span><br><span class="line">!~*为不区分大小写不匹配</span><br><span class="line">^~ 如果把这个前缀用于一个常规字符串,那么告诉nginx 如果路径匹配那么不测试正则表达式。</span><br><span class="line">123456</span><br></pre></td></tr></table></figure>

<p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">location = / &#123;</span><br><span class="line"> # 只匹配 / 查询。</span><br><span class="line">&#125;</span><br><span class="line">location / &#123;</span><br><span class="line"> # 匹配任何查询，因为所有请求都以 / 开头。但是正则表达式规则和长的块规则将被优先和查询匹配。</span><br><span class="line">&#125;</span><br><span class="line">location ^~ /images/ &#123;</span><br><span class="line"> # 匹配任何以 /images/ 开头的任何查询并且停止搜索。任何正则表达式将不会被测试。</span><br><span class="line">&#125;</span><br><span class="line">location ~*.(gif|jpg|jpeg)$ &#123;</span><br><span class="line"> # 匹配任何以 gif、jpg 或 jpeg 结尾的请求。</span><br><span class="line">&#125;</span><br><span class="line">location ~*.(gif|jpg|swf)$ &#123;</span><br><span class="line">  valid_referers none blocked start.igrow.cn sta.igrow.cn;</span><br><span class="line">  if ($invalid_referer) &#123;</span><br><span class="line">    #防盗链</span><br><span class="line">    rewrite ^/ http://$host/logo.png;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="try-files"><a href="#try-files" class="headerlink" title="try_files"></a>try_files</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">            try_files $uri $uri/ /index.php?$query_string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当用户请求 <code>http://localhost/example</code> 时，这里的 <code>$uri</code> 就是 <code>/example</code>。<br>try_files 会到硬盘里尝试找这个文件。如果存在名为 <code>/$root/example</code>（其中 <code>$root</code> 是项目代码安装目录）的文件，就直接把这个文件的内容发送给用户。<br>显然，目录中没有叫 example 的文件。然后就看 <code>$uri/</code>，增加了一个 <code>/</code>，也就是看有没有名为 <code>/$root/example/</code> 的目录。<br>又找不到，就会 fall back 到 try_files 的最后一个选项 &#x2F;index.php，发起一个内部 “子请求”，也就是相当于 nginx 发起一个 HTTP 请求到 <code>http://localhost/index.php</code>。 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">loaction / &#123;</span><br><span class="line"></span><br><span class="line">try_files $uri @apache</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">loaction @apache&#123;</span><br><span class="line"></span><br><span class="line">proxy_pass http://127.0.0.1:88</span><br><span class="line"></span><br><span class="line">include aproxy.conf</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>try_files</code>方法让<code>Ngxin</code>尝试访问后面得<code>$uri</code>链接，并进根据<code>@apache</code>配置进行内部重定向。</p>
<p>当然<code>try_files</code>也可以以错误代码赋值，如<code>try_files /index.php = 404 @apache</code>，则表示当尝试访问得文件返回<code>404</code>时，根据<code>@apache</code>配置项进行重定向。</p>
<h1 id="Nginx配置中的if判断"><a href="#Nginx配置中的if判断" class="headerlink" title="Nginx配置中的if判断"></a>Nginx配置中的if判断</h1><p>当rewrite的重写规则满足不了需求时，比如需要判断当文件不存在时、当路径包含xx时等条件，则需要用到if</p>
<h2 id="if语法"><a href="#if语法" class="headerlink" title="if语法"></a>if语法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (表达式) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>表达式语法：</p>
<p>当表达式只是一个变量时，如果值为空或任何以0开头的字符串都会当做false<br>直接比较变量和内容时，使用&#x3D;或!&#x3D;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-f和!-f用来判断是否存在文件</span><br><span class="line">-d和!-d用来判断是否存在目录</span><br><span class="line">-e和!-e用来判断是否存在文件或目录</span><br><span class="line">-x和!-x用来判断文件是否可执行</span><br></pre></td></tr></table></figure>

<p>为了配置if的条件判断，这里需要用到nginx中内置的全局变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$args               这个变量等于请求行中的参数，同$query_string</span><br><span class="line">$content_length     请求头中的Content-length字段。</span><br><span class="line">$content_type       请求头中的Content-Type字段。</span><br><span class="line">$document_root      当前请求在root指令中指定的值。</span><br><span class="line">$host               请求主机头字段，否则为服务器名称。</span><br><span class="line">$http_user_agent    客户端agent信息</span><br><span class="line">$http_cookie        客户端cookie信息</span><br><span class="line">$limit_rate         这个变量可以限制连接速率。</span><br><span class="line">$request_method     客户端请求的动作，通常为GET或POST。</span><br><span class="line">$remote_addr        客户端的IP地址。</span><br><span class="line">$remote_port        客户端的端口。</span><br><span class="line">$remote_user        已经经过Auth Basic Module验证的用户名。</span><br><span class="line">$request_filename   当前请求的文件路径，由root或alias指令与URI请求生成。</span><br><span class="line">$scheme             HTTP方法（如http，https）。</span><br><span class="line">$server_protocol    请求使用的协议，通常是HTTP/1.0或HTTP/1.1。</span><br><span class="line">$server_addr        服务器地址，在完成一次系统调用后可以确定这个值。</span><br><span class="line">$server_name        服务器名称。</span><br><span class="line">$server_port        请求到达服务器的端口号。</span><br><span class="line">$request_uri        包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”。</span><br><span class="line">$uri                不带请求参数的当前URI，$uri不包含主机名，如”/foo/bar.html”。</span><br><span class="line">$document_uri       与$uri相同。</span><br></pre></td></tr></table></figure>

<p>举例说明<br>1、如果文件不存在则返回400</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (!-f $request_filename) &#123;</span><br><span class="line">    return 400;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、如果host不是jouypub.com，则301到jouypub.com中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ( $host != &#x27;jouypub.com&#x27; )&#123;</span><br><span class="line">    rewrite ^/(.*)$ https://jouypub.com/$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、如果请求类型不是POST则返回405</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($request_method = POST) &#123;</span><br><span class="line">    return 405;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、如果参数中有a&#x3D;1则301到指定域名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($args ~ a=1) &#123;</span><br><span class="line">    rewrite ^ http://example.com/ permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、在某种场景下可结合location规则来使用，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#访问 /test.html 时</span><br><span class="line">location = /test.html &#123;</span><br><span class="line">    #设置默认值为xiaowu</span><br><span class="line">    set $name xiaowu;</span><br><span class="line">    #如果参数中有 name=xx 则使用该值 </span><br><span class="line">    if ($args ~* name=(\w+?)(&amp;|$)) &#123;</span><br><span class="line">            set $name $1;</span><br><span class="line">    &#125;</span><br><span class="line">    #301</span><br><span class="line">    rewrite ^ /$name.html permanent;</span><br><span class="line">&#125;</span><br><span class="line">#上面表示：</span><br><span class="line">#/test.html =&gt; /xiaowu.html</span><br><span class="line">#/test.html?name=ok =&gt; /ok.html?name=ok</span><br></pre></td></tr></table></figure>

<h1 id="强制跳转www"><a href="#强制跳转www" class="headerlink" title="强制跳转www"></a>强制跳转www</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($host != &#x27;www.1kmb.com&#x27;) &#123;</span><br><span class="line">	rewrite ^/(.*) https://www.1kmb.com/$1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="代理中的几点区别"><a href="#代理中的几点区别" class="headerlink" title="代理中的几点区别"></a>代理中的几点区别</h1><p>在nginx中配置proxy_pass代理转发时，如果在proxy_pass后面的url加&#x2F;，表示绝对根路径；如果没有&#x2F;，表示相对路径，把匹配的路径部分也给代理走。<br>假设下面四种情况分别用 <a target="_blank" rel="noopener" href="http://127.0.0.1/proxy/test.html">http://127.0.0.1/proxy/test.html</a> 进行访问。</p>
<p>第一种：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /proxy/ &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理到URL：<a target="_blank" rel="noopener" href="http://127.0.0.1/test.html">http://127.0.0.1/test.html</a></p>
<p>第二种（相对于第一种，最后少一个 &#x2F; ）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /proxy/ &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代理到URL：<a target="_blank" rel="noopener" href="http://127.0.0.1/proxy/test.html">http://127.0.0.1/proxy/test.html</a></p>
<p>第三种：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /proxy/ &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1/abc/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理到URL：<a target="_blank" rel="noopener" href="http://127.0.0.1/abc/test.html">http://127.0.0.1/abc/test.html</a></p>
<p>第四种（相对于第三种，最后少一个 &#x2F; ）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /proxy/ &#123;</span><br><span class="line">    proxy_pass http://127.0.0.1/abc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代理到URL：<a target="_blank" rel="noopener" href="http://127.0.0.1/abctest.html">http://127.0.0.1/abctest.html</a></p>
<h1 id="Nginx限流"><a href="#Nginx限流" class="headerlink" title="Nginx限流"></a>Nginx限流</h1><p>高并发系统有三把利器：缓存、降级和限流；限流的目的是通过对并发访问&#x2F;请求进行限速来保护系统，一旦达到限制速率则可以拒绝服务（定向到错误页）、排队等待（秒杀）、降级（返回兜底数据或默认数据）。 高并发系统常见的限流有：限制总并发数（数据库连接池）、限制瞬时并发数（如nginx的limit_conn模块，用来限制瞬时并发连接数）、限制时间窗口内的平均速率（nginx的limit_req模块，用来限制每秒的平均速率）。<br> 另外还可以根据网络连接数、网络流量、CPU或内存负载等来限流 </p>
<h2 id="Module-ngx-http-limit-conn-module"><a href="#Module-ngx-http-limit-conn-module" class="headerlink" title="Module ngx_http_limit_conn_module"></a>Module ngx_http_limit_conn_module</h2><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_limit_conn_module.html">http://nginx.org/en/docs/http/ngx_http_limit_conn_module.html</a></p>
<h2 id="限流算法"><a href="#限流算法" class="headerlink" title="限流算法"></a>限流算法</h2><p>计数器，令牌桶，漏桶</p>
<h2 id="请求限制"><a href="#请求限制" class="headerlink" title="请求限制"></a>请求限制</h2><p>依赖于nginx的ngx_http_limit_req_module模块，需要在http段配置参照标准和状态缓存区大小</p>
<ul>
<li>limit_req_zone 只能配置在 http 范围内；</li>
<li>$binary_remote_addr 表示客户端请求的IP地址；</li>
<li>mylimit 自己定义的变量名；</li>
<li>rate 请求频率，每秒允许多少请求；</li>
</ul>
<p>limit_req 与 limit_req_zone 对应，burst 表示缓存的请求数，也就是任务队列。</p>
<p>例如如下配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 定义了一个 mylimit 缓冲区（容器），请求频率为每秒 1 个请求（nr/s）</span><br><span class="line">limit_req_zone $binary_remote_addr zone=mylimit:10m rate=1r/s;</span><br><span class="line">server &#123;</span><br><span class="line">    listen  80;</span><br><span class="line">    location / &#123;</span><br><span class="line">        # nodelay 不延迟处理</span><br><span class="line">        # burst 是配置超额处理,可简单理解为队列机制</span><br><span class="line">        # 上面配置同一个 IP 没秒只能发送一次请求（1r/s），这里配置了缓存3个请求，就意味着同一秒内只能允许 4 个任务响应成功，其它任务请求则失败（503错误）</span><br><span class="line">        limit_req zone=mylimit burst=3 nodelay;</span><br><span class="line">        proxy_pass http://localhost:7070;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="并发限制"><a href="#并发限制" class="headerlink" title="并发限制"></a>并发限制</h2><p>Nginx 并发限制的功能来自于 ngx_http_limit_conn_module 模块，跟请求配置一样，使用它之前，需要先定义参照标准和状态缓存区。</p>
<ul>
<li>limit_conn_zone 只能配置在 http 范围内；</li>
<li>$binary_remote_addr 表示客户端请求的IP地址；</li>
<li>myconn 自己定义的变量名（缓冲区）；</li>
<li>limit_rate 限制传输速度</li>
<li>limit_conn 与 limit_conn_zone 对应，限制网络连接数</li>
</ul>
<p>下面的配置就是定义了使用客户端的 IP 作为参照依据，并使用一个 10M 大小的状态缓存区。限定了每个IP只允许建立一个请求连接，同时传输的速度最大为 1024KB</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 定义了一个 myconn 缓冲区（容器）</span><br><span class="line">limit_conn_zone $binary_remote_addr zone=myconn:10m;</span><br><span class="line">server &#123;</span><br><span class="line">    listen  70;</span><br><span class="line">    location / &#123;</span><br><span class="line">        # 每个 IP 只允许一个连接</span><br><span class="line">        limit_conn myconn 1;</span><br><span class="line">        # 限制传输速度（如果有N个并发连接，则是 N * limit_rate）</span><br><span class="line">        limit_rate 1024k;</span><br><span class="line">        proxy_pass http://localhost:7070;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原文地址：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1786015">https://cloud.tencent.com/developer/article/1786015</a></p>
<h1 id="Nginx代理后服务端使用remote-addr获取真实IP"><a href="#Nginx代理后服务端使用remote-addr获取真实IP" class="headerlink" title="Nginx代理后服务端使用remote_addr获取真实IP"></a>Nginx代理后服务端使用remote_addr获取真实IP</h1><p>在代理服务器的Nginx配置（yourWebsite.conf）的location &#x2F;中添加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#获取客户端IP</span><br><span class="line">proxy_set_header Host $host;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></pre></td></tr></table></figure>
<p>在业务服务器的Nginx配置（yourWebsite.conf）的location中添加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_param  HTTP_X_FORWARDED_FOR $http_x_forwarded_for;</span><br></pre></td></tr></table></figure>
<p>配置到这，可以用HTTP_X_FORWARDED_FOR获取客户端真实IP，以PHP为例，$_SERVER[‘HTTP_X_FORWARDED_FOR’]，但是remote_addr还是代理服务器的IP，接着往下配置，把remote_addr也配置成真实IP。</p>
<p>在业务服务器的Nginx配置（yourWebsite.conf）的location中继续添加：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set_real_ip_from 172.18.209.11/24;#这里的IP是代理服务器的IP，也可以是IP段。意思是把该IP请求过来的x_forwarded_for设为remote_addr</span><br><span class="line">real_ip_header X-Forwarded-For;</span><br></pre></td></tr></table></figure>
<p>Tip：添加上面两行之前，需要查看Nginx是否安装了realip模块，Nginx默认是不安装的，查看命令 nginx -V ，结果如下所示，如果没有realip模块，需要先安装。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nginx version: nginx/1.14.0</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-28) (GCC) </span><br><span class="line">built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --with-select_module --with-poll_module --with-threads --with-file-aio --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_auth_request_module --with-http_random_index_module --with-http_degradation_module --with-http_slice_module --with-http_stub_status_module --with-stream --with-stream=dynamic --with-stream_ssl_module --with-pcre --add-module=/usr/local/nginx_upstream_check_module-master/</span><br></pre></td></tr></table></figure>

<h1 id="关于nginx不支持PATHINFO问题的解决"><a href="#关于nginx不支持PATHINFO问题的解决" class="headerlink" title="关于nginx不支持PATHINFO问题的解决"></a>关于nginx不支持PATHINFO问题的解决</h1><p>配置好的NGINX配置文件</p>
<pre><code>server &#123;
    listen       80;
    server_name  www.newmvc.com;
 
    root /Users/likang/Desktop/mvc_new;
    #charset koi8-r;
 
    access_log  logs/www.newmvc.com.access.log  main;
    error_log  logs/www.newmvc.com.error.log;
 
    location / &#123;
        autoindex on;
        index index.php index.html index.htm;
    &#125;
    #error_page  404              /404.html;
 
    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html &#123;
    &#125;
 
    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ &#123;
    #    proxy_pass   http://127.0.0.1;
    #&#125;
 
    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    location ~ \.php &#123;
        fastcgi_pass   127.0.0.1:9000;
        fastcgi_index  index.php;
        include        fastcgi_params;
 
 
        set $real_script_name $fastcgi_script_name;
        if ($fastcgi_script_name ~ &quot;^(.+?\.php)(/.+)$&quot;) &#123;
            set $real_script_name $1;
            set $path_info $2;
        &#125;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $path_info;
    &#125;
 
    # deny access to .htaccess files, if Apache&#39;s document root
    # concurs with nginx&#39;s one
    #
    #location ~ /\.ht &#123;
    #    deny  all;
    #&#125;
&#125;
</code></pre>
<p>需要注意的是 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location ~ \.php</span><br></pre></td></tr></table></figure>


<p>这个地方$ 要去掉</p>
<pre><code>还有一种更简单的办法，还是不支持pathinfo使用另外的路由模式，也能解决问题，建议使用第一种办法
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (!-e $request_filename) &#123;</span><br><span class="line">   rewrite  ^index.php/(.*)$  /index.php?$1  last;</span><br><span class="line">   break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-15T12:07:17.000Z" title="2021/6/15 下午8:07:17">2021-06-15</time>发表</span><span class="level-item"><time dateTime="2022-08-28T02:23:10.673Z" title="2022/8/28 上午10:23:10">2022-08-28</time>更新</span><span class="level-item">3 分钟读完 (大约438个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/06/15/Ubuntu20.04%20%E4%B8%AD%E6%96%87%E6%98%BE%E7%A4%BA%E4%B8%8D%E6%AD%A3%E7%A1%AE%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">Ubuntu20.04 中文显示不正确的解决方案</a></h1><div class="content"><p>今天又买了一台腾讯云，想学学linux，就没有安装宝塔。搭建好网站后发现中文显示有问题。查阅一番资料后知道原来需要安装语言包。<br>如下图是没有安装语言包的文件列表:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">drwxr-xr-x 11 root root  4096 Jun 14 09:52  ./</span><br><span class="line">drwxr-xr-x  4 root root  4096 Jun 14 09:53  ../</span><br><span class="line">-rwxr-xr-x  1 root root    18 Apr 28 22:24  .htaccess*</span><br><span class="line">-rw-r--r--  1 root root    47 Oct 22  2020  .user.ini</span><br><span class="line">drwxr-xr-x  6 root root  4096 May 23 22:21  app/</span><br><span class="line">-rwxr-xr-x  1 root root   684 May  5 11:32  composer.json*</span><br><span class="line">-rwxr-xr-x  1 root root 23126 Jun 10 22:57  composer.lock*</span><br><span class="line">drwxr-xr-x  2 root root  4096 Jun  6 10:35  config/</span><br><span class="line">drwxr-xr-x  2 root root  4096 Apr 28 22:24  extend/</span><br><span class="line">-rwxr-xr-x  1 root root   506 Apr 28 22:24  max*</span><br><span class="line">drwxr-xr-x  4 root root  4096 Jun 14 10:14  public/</span><br><span class="line">drwxr-xr-x  2 root root  4096 Apr 28 22:24  routes/</span><br><span class="line">drwxrwxrwx  4 root root  4096 Jun 12 14:36  storage/</span><br><span class="line">drwxr-xr-x  8 root root  4096 Jun 14 10:47  vendor/</span><br><span class="line">drwxr-xr-x  3 root root  4096 May 18 14:05  views/</span><br><span class="line">drwxr-xr-x  2 root root  4096 Jun 12 05:51 &#x27;&#x27;$&#x27;\346\226\207\346\241\243&#x27;/</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面介绍下一般的解决办法：</p>
<p>首先安装语言包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install language-pack-zh-hans</span><br></pre></td></tr></table></figure>

<p>安装完成后需要将我们的LANG设置为中文。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">locale -a </span><br></pre></td></tr></table></figure>
<p>上面命令查看安装的语言</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@VM-0-10-ubuntu:/var/www/chengyao.xyz# locale -a</span><br><span class="line">C</span><br><span class="line">C.UTF-8</span><br><span class="line">POSIX</span><br><span class="line">en_US.utf8</span><br><span class="line">zh_CN.utf8</span><br><span class="line">zh_SG.utf8</span><br></pre></td></tr></table></figure>
<p>接下来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export LANG=zh_CN.utf8</span><br></pre></td></tr></table></figure>
<p>然后看下文件列表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">drwxr-xr-x 11 root root  4096 6月  14 09:52 ./</span><br><span class="line">drwxr-xr-x  4 root root  4096 6月  14 09:53 ../</span><br><span class="line">drwxr-xr-x  2 root root  4096 6月  12 05:51 文档/</span><br><span class="line">drwxr-xr-x  6 root root  4096 5月  23 22:21 app/</span><br><span class="line">-rwxr-xr-x  1 root root   684 5月   5 11:32 composer.json*</span><br><span class="line">-rwxr-xr-x  1 root root 23126 6月  10 22:57 composer.lock*</span><br><span class="line">drwxr-xr-x  2 root root  4096 6月   6 10:35 config/</span><br><span class="line">drwxr-xr-x  2 root root  4096 4月  28 22:24 extend/</span><br><span class="line">-rwxr-xr-x  1 root root    18 4月  28 22:24 .htaccess*</span><br><span class="line">-rwxr-xr-x  1 root root   506 4月  28 22:24 max*</span><br><span class="line">drwxr-xr-x  4 root root  4096 6月  14 10:14 public/</span><br><span class="line">drwxr-xr-x  2 root root  4096 4月  28 22:24 routes/</span><br><span class="line">drwxrwxrwx  4 root root  4096 6月  12 14:36 storage/</span><br><span class="line">-rw-r--r--  1 root root    47 10月 22  2020 .user.ini</span><br><span class="line">drwxr-xr-x  8 root root  4096 6月  14 10:47 vendor/</span><br><span class="line">drwxr-xr-x  3 root root  4096 5月  18 14:05 views/</span><br></pre></td></tr></table></figure>

<p><code>文档</code>被显示出来了。</p>
<p>最后我将他添加到家目录下的<code>.bashrc</code>文件里</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export LANG=zh_CN.utf8</span><br></pre></td></tr></table></figure>

<p>就可以一直正常显示中文了。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-29T07:39:42.000Z" title="2021/5/29 下午3:39:42">2021-05-29</time>发表</span><span class="level-item"><time dateTime="2022-08-28T02:23:10.673Z" title="2022/8/28 上午10:23:10">2022-08-28</time>更新</span><span class="level-item">1 分钟读完 (大约167个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/29/golang%E4%B8%AD%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E5%8F%98%E9%87%8F%E7%9A%84%E7%B1%BB%E5%9E%8B%EF%BC%9F/">golang中如何获取变量的类型？</a></h1><div class="content"><p>在golang中并没有提供内置函数来获取变量的类型，但是通过一定的方式也可以获取，下面提供两种思路</p>
<h1 id="通过格式化"><a href="#通过格式化" class="headerlink" title="通过格式化"></a>通过格式化</h1><p>使用格式化字符%T(注意为大写的T)便可以获取到对应的类型</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> v <span class="type">int</span> = <span class="number">64</span></span><br><span class="line">	fmt.Printf(&amp;quot;v的值为: %v, v的类型为: %T\n&amp;quot;, v, v)</span><br><span class="line">	<span class="comment">// 如果想要保存类型到字符串中，可以使用</span></span><br><span class="line">	typ := fmt.Sprintf(&amp;quot;%T&amp;quot;, v)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="通过反射机制"><a href="#通过反射机制" class="headerlink" title="通过反射机制"></a>通过反射机制</h1><p>reflect包中提供了相应的手段</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	&amp;quot;fmt&amp;quot;</span><br><span class="line">	&amp;quot;reflect&amp;quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> v <span class="type">int</span> = <span class="number">64</span></span><br><span class="line">	fmt.Println(reflect.TypeOf(v))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-18T02:48:32.000Z" title="2021/5/18 上午10:48:32">2021-05-18</time>发表</span><span class="level-item"><time dateTime="2022-08-28T02:23:10.673Z" title="2022/8/28 上午10:23:10">2022-08-28</time>更新</span><span class="level-item">几秒读完 (大约18个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/18/apache%E6%A8%A1%E5%9D%97%E4%BD%BF%E7%94%A8/">apache模块使用</a></h1><div class="content"><p>加载SSL模块<br>sudo a2enmod ssl</p>
<p>sudo a2enmod http_proxy<br>sudo a2enmod proxy</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-16T15:07:44.000Z" title="2021/5/16 下午11:07:44">2021-05-16</time>发表</span><span class="level-item"><time dateTime="2022-08-28T02:23:10.673Z" title="2022/8/28 上午10:23:10">2022-08-28</time>更新</span><span class="level-item">11 分钟读完 (大约1599个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/16/%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E9%98%B2%E6%AD%A2%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">高并发下防止库存超卖的解决方案</a></h1><div class="content"><p>最近在看秒杀相关的项目，针对防止库存超卖的问题，查阅了很多资料，其解决方案可以分为悲观锁、乐观锁、分布式锁、Redis原子操作、队列串行化等等，这里进行浅显的记录总结。</p>
<p>首先我们来看下库存超卖问题是怎样产生的：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span><span class="number">1.</span>查询出商品库存信息</span><br><span class="line"><span class="keyword">select</span> stock <span class="keyword">from</span> t_goods <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span><span class="number">2.</span>根据商品信息生成订单</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_orders (id,goods_id) <span class="keyword">values</span> (<span class="keyword">null</span>,<span class="number">1</span>);</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span><span class="number">3.</span>修改商品库存</span><br><span class="line"><span class="keyword">update</span> t_goods <span class="keyword">set</span> stock<span class="operator">=</span>stock<span class="number">-1</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>在高并发场景下，如果同时有两个线程a和b，同时查询到商品库存为1，他们都认为存库充足，于是开始下单减库存。如果线程a先完成减库存操作，库存为0，接着线程b也是减库存，于是库存就变成了-1，商品被超卖了。</p>
<p>下面让我们来看看针对库存超卖问题的解决方案；</p>
<h1 id="解决方案一：悲观锁"><a href="#解决方案一：悲观锁" class="headerlink" title="解决方案一：悲观锁"></a>解决方案一：悲观锁</h1><p>所谓悲观锁，即悲观的认为自己在操作数据库时，会大几率出现并发，于是在操作前会先进行加锁，操作完成后再释放锁。如果加锁失败说明该记录正在被修改，那么当前操作可以等待后尝试。</p>
<p>以我们常用的MySQL为例，行锁、表锁、排他锁等都是悲观锁，为避免冲突，会在操作时先加锁，其他线程必须等待它的完成。</p>
<p>这里我们通过使用select…for update语句，在查询商品表库存时将该条记录加锁，待下单减库存完成后，再释放锁。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span><span class="number">0.</span>开始事务</span><br><span class="line"><span class="keyword">begin</span>;<span class="operator">/</span><span class="keyword">begin</span> work;<span class="operator">/</span><span class="keyword">start</span> transaction; (三者选一就可以)</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span><span class="number">1.</span>查询出商品信息</span><br><span class="line"><span class="keyword">select</span> stock <span class="keyword">from</span> t_goods <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span><span class="number">2.</span>根据商品信息生成订单</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_orders (id,goods_id) <span class="keyword">values</span> (<span class="keyword">null</span>,<span class="number">1</span>);</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span><span class="number">3.</span>修改商品stock减一</span><br><span class="line"><span class="keyword">update</span> t_goods <span class="keyword">set</span> stock<span class="operator">=</span>stock<span class="number">-1</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span><span class="number">4.</span>提交事务</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>

<p>这样可以解决并发时库存超卖的问题，然而高并发时，所有的操作都被串行化了，效率很低，将严重影响系统的吞吐量。而且使用悲观锁还有可能造成死锁问题。</p>
<h1 id="解决方案二：乐观锁"><a href="#解决方案二：乐观锁" class="headerlink" title="解决方案二：乐观锁"></a>解决方案二：乐观锁</h1><p>现在我们尝试下使用乐观锁，所谓乐观锁，是相对于悲观锁而言的，它假设数据一般情况下不会发生并发，因此不会对数据进行加锁，操作完成提交时才对数据是否冲突进行检测，如果发现冲突则返回错误。</p>
<p>比较常见的实现方式是，在表中增加一个version字段，操作前先查询version信息，在数据提交时检查version字段是否被修改，如果没有被修改则进行提交，否则认为是过期数据。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span><span class="number">1.</span>查询出商品信息</span><br><span class="line"><span class="keyword">select</span> stock, version <span class="keyword">from</span> t_goods <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span><span class="number">2.</span>根据商品信息生成订单</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_orders (id,goods_id) <span class="keyword">values</span> (<span class="keyword">null</span>,<span class="number">1</span>);</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span><span class="number">3.</span>修改商品库存</span><br><span class="line"><span class="keyword">update</span> t_goods <span class="keyword">set</span> stock<span class="operator">=</span>stock<span class="number">-1</span>, version <span class="operator">=</span> version<span class="operator">+</span><span class="number">1</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span>, version<span class="operator">=</span>version;</span><br></pre></td></tr></table></figure>

<p>这样，在并发时，如果线程a尝试修改商品库存时，发现版本号已经被线程b修改了，线程a执行update语句条件不满足便不再执行了，库存也不会被超卖。</p>
<p>但是这种乐观锁的方式，在高并发时，只有一个线程能执行成功，会造成大量的失败，这给用户的体验显然是很不好的。</p>
<p>这里我们可以减小锁的颗粒度，最大程度提升系统的吞吐量，提高并发能力：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span>修改商品库存时判断库存是否大于<span class="number">0</span></span><br><span class="line"><span class="keyword">update</span> t_goods <span class="keyword">set</span> stock<span class="operator">=</span>stock<span class="number">-1</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> stock<span class="operator">&amp;</span>gt;<span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>上面的update语句通过stock&gt;0进行乐观锁的控制，在执行时，会在一次原子操作中查询stock的值，并扣减一。</p>
<h1 id="解决方案三：分布式锁"><a href="#解决方案三：分布式锁" class="headerlink" title="解决方案三：分布式锁"></a>解决方案三：分布式锁</h1><p>除了在数据库层面加锁，我们还可以通过在内存中加锁，实现分布式锁。例如我们可以在Redis中设置一个锁，拿到锁的线程抢购成功，拿不到锁的抢购失败。</p>
<p>Redis的setnx方法可以实现锁机制，key不存在时创建，并设置value，返回值为1；key存在时直接返回0。线程调用setnx方法成功返回1认为加锁成功，其他线程要等到当前线程业务操作完成释放锁后，才能再次调用setnx加锁成功。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Long</span> <span class="variable">TIMEOUT_SECOUND</span> <span class="operator">=</span> <span class="number">120000L</span>;</span><br><span class="line"><span class="type">Jedis</span> <span class="variable">client</span> <span class="operator">=</span> jedisPool.getResource();</span><br><span class="line"><span class="comment">//线程设置lock锁成功</span></span><br><span class="line"><span class="keyword">while</span>(client.setnx(&amp;quot;lock&amp;quot;,String.valueOf(System.currentTimeMillis())) == <span class="number">1</span>)&#123;</span><br><span class="line"><span class="type">Long</span> <span class="variable">lockTime</span> <span class="operator">=</span> Long.valueOf(client.get(&amp;quot;lock&amp;quot;));</span><br><span class="line"><span class="comment">//持有锁超时后自动释放锁</span></span><br><span class="line"><span class="keyword">if</span> (lockTime!=<span class="literal">null</span> &amp;amp;&amp;amp; System.currentTimeMillis() &amp;gt; lockTime+TIMEOUT_SECOUND)&#123;</span><br><span class="line">client.del(&amp;quot;lock&amp;quot;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">Thread.sleep(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">client.del(&amp;quot;lock&amp;quot;);</span><br></pre></td></tr></table></figure>

<h1 id="解决方案四：Redis原子操作"><a href="#解决方案四：Redis原子操作" class="headerlink" title="解决方案四：Redis原子操作"></a>解决方案四：Redis原子操作</h1><p>虽然通过以上方按可以防止库存超卖，但是高并发情况下对数据库进行频繁操作，会造成严重的性能问题。因此我们必须在前端对请求进行限制。</p>
<p>我们可以在Redis中设置一个队列key为商品的id，队列的长度为商品库存量。每次请求到达时pop出一个元素，这样拿到元素的请求即认为秒杀成功，后续通过MQ发送消息异步完成数据库减库存操作。没有拿到元素的请求即认为秒杀失败。</p>
<p>由于Redis是工作线程是单线程的，而list的pop操作是原子性的，因此并发的请求都被串行化了，库存就不会超卖了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取商品库存</span></span><br><span class="line"><span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> redisTemplate.opsForList().leftPop(goodsStock);</span><br><span class="line"><span class="keyword">if</span>(token == <span class="literal">null</span>)&#123;</span><br><span class="line">log.info(&amp;quot;&amp;gt;&amp;gt;&amp;gt;商品已售空&amp;quot;);</span><br><span class="line"><span class="keyword">return</span> setResultError(&amp;quot;亲，该秒杀已经售空，请下次再来!&amp;quot;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//异步发送MQ消息，执行数据库操作</span></span><br><span class="line">sendSecondKillMsg(goodsId, userId);</span><br></pre></td></tr></table></figure>

<p>…<br>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/yishihuakai/article/details/104581576">https://blog.csdn.net/yishihuakai/article/details/104581576</a></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/9/">上一页</a></div><div class="pagination-next"><a href="/page/11/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/9/">9</a></li><li><a class="pagination-link is-current" href="/page/10/">10</a></li><li><a class="pagination-link" href="/page/11/">11</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/17/">17</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/images/avatar.jpg" alt="程"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">程</p><p class="is-size-6 is-block">未至精疲力尽，不要怨天尤人。昨日因，今日果。今日为，明日果也！</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Earth</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">170</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/tab-engineer" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/tab-engineer"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-01T06:56:20.000Z">2022-10-01</time></p><p class="title"><a href="/2022/10/01/tcpdump%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B/">tcpdump详细教程</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-09-18T05:06:34.000Z">2022-09-18</time></p><p class="title"><a href="/2022/09/18/Typescript%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">Typescript学习笔记</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-09-04T13:30:39.000Z">2022-09-04</time></p><p class="title"><a href="/2022/09/04/Go%E5%90%84%E6%97%B6%E9%97%B4%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E8%A7%A3%E6%9E%90/">Go各时间字符串的解析</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-08-21T02:56:27.000Z">2022-08-21</time></p><p class="title"><a href="/2022/08/21/%E7%89%88%E6%9C%AC%E5%8F%B7%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83/">版本号命名规范</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-08-19T12:54:39.000Z">2022-08-19</time></p><p class="title"><a href="/2022/08/19/Markdown%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/">Markdown基本语法</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">九月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">二月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">十二月 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">21</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/images/avatar.jpg" alt="笔记" height="28"></a><p class="is-size-7"><span>&copy; 2022 CY</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>