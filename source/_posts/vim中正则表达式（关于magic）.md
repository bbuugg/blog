---
title: vim中正则表达式（关于magic）
date: 2021-04-15 08:55:44
tags:
---

>毋庸多言，在vim中正则表达式得到了十分广泛的应用。最常用的 / 和 :s 命令中，正则表达式都是不可或缺的。下面对vim中的正则表达式的一些难点进行说明

# 关于magic

vim中有个<b style="color:red">magic</b>的设定，设定方法为：

```
:set magic             " 设置magic
:set nomagic           " 取消magic
:h magic               " 查看帮助
```

vim毕竟是个编辑器，正则表达式中包含的大量元字符如果原封不动地引用（像perl那样），势必会给不懂正则表达式的人造成麻烦，比如 /foo(1) 命令，大多数人都用它来查找foo(1)这个字符串，但如果按照正则表达式来解释，被查找的对象就成了 foo1 了。

于是，vim就规定，正则表达式的元字符必须用反斜杠进行转义才行，如上面的例子，如果确实要用正则表达式，就应当写成 /foo/(1/) 。但是，像 . * 这种极其常用的元字符，都加上反斜杠就太麻烦了。而且，众口难调，有些人喜欢用正则表达式，有些人不喜欢用……

为了解决这个问题，vim设置了 magic 这个东西。简单地说， magic就是设置哪些元字符要加反斜杠哪些不用加的。简单来说：

- **magic** (/m)：除了 $ . * ^ 之外其他元字符都要加反斜杠。
- **nomagic** (/M)：除了 $ ^ 之外其他元字符都要加反斜杠。

这个设置也可以在正则表达式中通过 /m /M 开关临时切换。 /m 后面的正则表达式会按照 magic 处理，/M 后面的正则表达式按照 nomagic 处理，而忽略实际的magic设置。

例如：

```
//m.*          # 查找任意字符串
//M.*          # 查找字符串 .* （点号后面跟个星号）
```

另外还有更强大的 /v 和 /V。

- **/v** （即 very magic 之意）：任何元字符都不用加反斜杠
- **/V** （即 very nomagic 之意）：任何元字符都必须加反斜杠

例如：

```
//v(a.c){3}$   # 查找行尾的abcaccadc
//m(a.c){3}$   # 查找行尾的(abc){3}
//M(a.c){3}$   # 查找行尾的(a.c){3}
//V(a.c){3}$   # 查找任意位置的(a.c){3}$
```

默认设置是 magic，vim也推荐大家都使用magic的设置，在有特殊需要时，直接通过 /v/m/M/V 即可。

本文下面使用的元字符都是 magic 模式下的。

# 量词

vim的量词与perl相比一点也不逊色。

| vim      | Perl   | 意义                                                  |
| -------- | ------ | ----------------------------------------------------- |
| *        | *      | 0个或多个(匹配优先)                                   |
| /+       | +      | 1个或多个(匹配优先)                                   |
| /? 或 /= | ?      | 0个或1个(匹配优先)，/?不能在 ? 命令（逆向查找）中使用 |
| /{n,m}   | {n,m}  | n个到m个(匹配优先)                                    |
| /{n,}    | {n,}   | 最少n个(匹配优先)                                     |
| /{,m}    | {,m}   | 最多m个(匹配优先)                                     |
| /{n}     | {n}    | 恰好n个                                               |
| /{-n,m}  | {n,m}? | n个到m个(忽略优先)                                    |
| /{-}     | *?     | 0个或多个(忽略优先)                                   |
| /{-1,}   | +?     | 1个或多个(忽略优先)                                   |
| /{-,1}   | ??     | 0个或1个(忽略优先)                                    |

从上表中可见，vim的忽略优先量词不像perl的 *? +? ?? 那样，而是统一使用 /{- 实现的。这大概跟忽略优先量词不常用有关吧。

# 环视和固化分组

vim居然还支持环视和固化分组的功能，强大，赞一个 ![:D](http://tech.idv2.com/2008/07/08/vim-regexp/images/face/bigsmile.png) 关于环视的解释请参考Yurii的[《精通正则表达式》](http://www.douban.com/subject/2154713/) 一书吧。

| vim       | Perl | 意义         |
| --------- | ---- | ------------ |
| /@=       | (?=  | 顺序环视     |
| /@!       | (?!  | 顺序否定环视 |
| /@<=      | (?<= | 逆序环视     |
| /@<!      | (?<! | 逆序否定环视 |
| /@>       | (?>  | 固化分组     |
| /%(atom/) | (?:  | 非捕获型括号 |

和perl稍有不同的是，vim中的环视和固化分组的模式的位置与perl不同。例如，查找紧跟在 foo 之后的 bar，perl将模式写在环视的括号内，而vim将模式写在环视的元字符之前。

```
# Perl的写法
/(?<=foo)bar/

# vim的写法
//(foo/)/@<=bar
```